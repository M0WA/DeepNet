<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>DeepNet: QueryServer/src/XMLQueryResponse.cpp Source File</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />

<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">DeepNet
   
   </div>
   <div id="projectbrief">search engine framework and applications</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">QueryServer/src/XMLQueryResponse.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d7/dc5/XMLQueryResponse_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * XMLQueryResponse.cpp</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> *  Created on: 16.03.2012</span>
<a name="l00005"></a>00005 <span class="comment"> *      Author: Moritz Wagner</span>
<a name="l00006"></a>00006 <span class="comment"> */</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d1b/XMLQueryResponse_8h.html">XMLQueryResponse.h</a>&quot;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;<a class="code" href="../../de/d87/Logging_8h.html">Logging.h</a>&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;<a class="code" href="../../d4/d4d/HttpCookie_8h.html">HttpCookie.h</a>&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;<a class="code" href="../../d2/d28/HttpUrlParser_8h.html">HttpUrlParser.h</a>&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;<a class="code" href="../../d0/df6/CacheDatabaseUrl_8h.html">CacheDatabaseUrl.h</a>&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;<a class="code" href="../../d4/d23/StringTools_8h.html">StringTools.h</a>&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;<a class="code" href="../../da/d3c/ContainerTools_8h.html">ContainerTools.h</a>&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;<a class="code" href="../../d7/d73/DatabaseHelper_8h.html">DatabaseHelper.h</a>&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;<a class="code" href="../../d6/d73/DatabaseLayer_8h.html" title="include this header for database functionality.">DatabaseLayer.h</a>&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;<a class="code" href="../../d0/d2b/WhereConditionTableColumn_8h.html">WhereConditionTableColumn.h</a>&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;<a class="code" href="../../da/df0/WhereConditionTableColumnCreateParam_8h.html">WhereConditionTableColumnCreateParam.h</a>&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;<a class="code" href="../../d5/d08/TableColumnDefinitionCreateParam_8h.html">TableColumnDefinitionCreateParam.h</a>&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;<a class="code" href="../../d1/ddd/TableColumnDefinition_8h.html">TableColumnDefinition.h</a>&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;<a class="code" href="../../dc/dd4/TableColumn_8h.html">TableColumn.h</a>&gt;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dc3/XMLQueryRequest_8h.html">XMLQueryRequest.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d47/Relevance_8h.html">Relevance.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/KeywordEntry_8h.html">KeywordEntry.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d86/UrlStageEntry_8h.html">UrlStageEntry.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d0c/BackLinkEntry_8h.html">BackLinkEntry.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d53/PageInfo_8h.html">PageInfo.h</a>&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="keyword">namespace </span>queryserver {
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a2e77c86c72f02c17ba0f0a1ef05add29">00033</a> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a2e77c86c72f02c17ba0f0a1ef05add29">XMLQueryResponse::XMLQueryResponse</a>(<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html" title="helper class for a database connection.">database::DatabaseHelper</a>&amp; dbHelper,<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html">XMLQueryRequest</a>* xmlQueryRequest)
<a name="l00034"></a>00034 : fastcgiserver::FastCGIResponse(xmlQueryRequest)
<a name="l00035"></a>00035 , xmlQueryRequest(xmlQueryRequest)
<a name="l00036"></a>00036 , dbHelper(dbHelper)
<a name="l00037"></a>00037 , countResults(-1)
<a name="l00038"></a>00038 {
<a name="l00039"></a>00039 }
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a6257fc768e8e7313b345dc57b0e18d2d">00041</a> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a6257fc768e8e7313b345dc57b0e18d2d">XMLQueryResponse::~XMLQueryResponse</a>()
<a name="l00042"></a>00042 {
<a name="l00043"></a>00043 }
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4494406c67200e06666eb7f5eedc3695">00045</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4494406c67200e06666eb7f5eedc3695" title="processes fastcgi client request.">XMLQueryResponse::Process</a>(FCGX_Request&amp; request)
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047         <span class="comment">//fetch keywords from request</span>
<a name="l00048"></a>00048         <span class="keyword">const</span> std::list&lt;std::string&gt;&amp; allKeyWords = <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a4ef37d54242dba71d89237cbae8b69f7">QueryParts</a>();
<a name="l00049"></a>00049         std::vector&lt;std::string&gt; vecKeywords;
<a name="l00050"></a>00050         <a class="code" href="../../d6/d19/classtools_1_1ContainerTools.html#a35fb4a96c7aeea6a3ab20bda91dc6411" title="converts std::list to std::vector">tools::ContainerTools::ListToVector</a>(allKeyWords,vecKeywords);
<a name="l00051"></a>00051 
<a name="l00052"></a>00052         <span class="keywordtype">bool</span> isExisting = <span class="keyword">false</span>;
<a name="l00053"></a>00053         <span class="keywordflow">if</span>(!<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a135a325a76308f4205c77a474d02ffbb">LogQuery</a>(vecKeywords,isExisting))
<a name="l00054"></a>00054                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00055"></a>00055 
<a name="l00056"></a>00056         <span class="keywordflow">if</span>(!isExisting)
<a name="l00057"></a>00057                 <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a64bd5389d32e1e12ec34d33d1718478c">ProcessNewQuery</a>(vecKeywords);
<a name="l00058"></a>00058 
<a name="l00059"></a>00059         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a5c3fdc96737dedf7e71607b77e034361">ProcessExistQuery</a>();
<a name="l00060"></a>00060         <span class="keywordflow">return</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4494406c67200e06666eb7f5eedc3695" title="processes fastcgi client request.">fastcgiserver::FastCGIResponse::Process</a>(request);
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a5c3fdc96737dedf7e71607b77e034361">00063</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a5c3fdc96737dedf7e71607b77e034361">XMLQueryResponse::ProcessExistQuery</a>()
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065         <span class="keywordtype">long</span> <span class="keywordtype">long</span> startResult = <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a2cd970369c08d039038c5d0613de0b92">PageNumber</a>() * <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a094ce6163ae6b438d6c09fb468dab3bb">MaxResults</a>();
<a name="l00066"></a>00066         <span class="keywordtype">long</span> <span class="keywordtype">long</span> stopResult  = startResult + <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a094ce6163ae6b438d6c09fb468dab3bb">MaxResults</a>() -1;
<a name="l00067"></a>00067         <span class="keywordflow">if</span>(stopResult&lt;startResult)
<a name="l00068"></a>00068                 stopResult=startResult+1;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070         <a class="code" href="../../df/dba/classdatabase_1_1SelectResultContainer.html" title="container for results of SELECT statements.">database::SelectResultContainer&lt;database::queryresultsTableBase&gt;</a> results;
<a name="l00071"></a>00071         std::vector&lt;database::WhereConditionTableColumn*&gt; whereContainer;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073         <a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a7d5d8e4f7de00a3eabd8bd1cb11999b4" title="creates where condition for a value of SEARCHQUERY_ID.">database::queryresultsTableBase::GetWhereColumnsFor_SEARCHQUERY_ID</a>(
<a name="l00074"></a>00074                 <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a>(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a8f97bdd20995e906f92e9657958a0eb6">database::WhereCondition::InitialComp</a>()),
<a name="l00075"></a>00075                 <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a0085f0e0633866ec7e7cc81c00fa1f7c">QueryID</a>(),
<a name="l00076"></a>00076                 whereContainer );
<a name="l00077"></a>00077 
<a name="l00078"></a>00078         <a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#ad363e00824323e77f412b1353f1dad25" title="creates where condition for a value of order_position.">database::queryresultsTableBase::GetWhereColumnsFor_order_position</a>(
<a name="l00079"></a>00079                 <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a>(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#ade32ad2e57e51c0696301fa8e91a1e0d">database::WhereCondition::GreaterOrEqual</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#ab74611e18cb57252673663bb5e2ff6de">database::WhereCondition::And</a>()),
<a name="l00080"></a>00080                 startResult,
<a name="l00081"></a>00081                 whereContainer );
<a name="l00082"></a>00082 
<a name="l00083"></a>00083         database::queryresultsTableBase::GetWhereColumnsFor_order_position(
<a name="l00084"></a>00084                 <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a>(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a80391a1fd38d8b55f717c24402c62736">database::WhereCondition::SmallerOrEqual</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#ab74611e18cb57252673663bb5e2ff6de">database::WhereCondition::And</a>()),
<a name="l00085"></a>00085                 stopResult,
<a name="l00086"></a>00086                 whereContainer );
<a name="l00087"></a>00087 
<a name="l00088"></a>00088         <a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html" title="implements generic sql select statement.">database::SelectStatement</a> selectResults(<a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a340f6361e6153ec98afe7e0170f33b5e" title="factory function for queryresults&#39;s table definition.">database::queryresultsTableBase::CreateTableDefinition</a>());
<a name="l00089"></a>00089         selectResults.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#ad4576687383c4de60705747802b24280" title="selects all columns of statement&#39;s table.">SelectAllColumns</a>();
<a name="l00090"></a>00090         selectResults.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a2449145166e97f78a3a2428b06e0275c" title="gets where condition of this statement.">Where</a>().<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a958e50302a66209914132a02c57e2088" title="add multiple where conditions for multiple columns.">AddColumns</a>(whereContainer);
<a name="l00091"></a>00091         selectResults.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a650aec0d1b7e74a456e62c0a514e028d" title="gets order by clause of this statement.">OrderBy</a>().<a class="code" href="../../dc/dc8/classdatabase_1_1OrderByClause.html#a5ce495eec08d255060a624788a8bd66d" title="add column to order by.">AddColumn</a>(<a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a29961cf8e8971234ef6f8ec6f9f68a2b" title="create a column definition for column SEARCHQUERY_ID.">database::queryresultsTableBase::GetDefinition_SEARCHQUERY_ID</a>(), <a class="code" href="../../da/df2/namespacedatabase.html#af93a39435af4e48debe6d634403174f6adfb6ef4568e14e7b8a42ba3406495464" title="ascending order.">database::ASCENDING</a>);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ac81a7a18a1b45a2a5809a923cdc91395" title="execute select statement.">Select</a>(selectResults,results);
<a name="l00094"></a>00094         <span class="keywordflow">if</span>(results.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1530b8ead15a2f1b821f4ef62c248c77" title="gets current container size.">Size</a>() == 0)
<a name="l00095"></a>00095                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097         std::vector&lt;long long&gt; sortedUrlStageIDs;
<a name="l00098"></a>00098         std::map&lt;long long, long long&gt; mapUrlStageIDUrlID;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         results.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a384f051671e8058d5b9ed38e21dca16c" title="resets iterator.">ResetIter</a>();
<a name="l00101"></a>00101         <span class="keywordflow">for</span>( ;!results.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a7c7e995e6f634648f8e02dd139f60737" title="checks if iterator is at end.">IsIterEnd</a>(); results.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1b1ed522439feadf4836dea1ad3bc1ff" title="increment iterator.">Next</a>()) {
<a name="l00102"></a>00102                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlStageID = -1, urlID = -1;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104                 <span class="keyword">const</span> <a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html" title="wrapper class for database table queryresults">database::queryresultsTableBase</a>* pRow = results.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#ab6f7fab0c152ec5388a63ab94f52c3f6" title="gets current iterator.">GetIter</a>();
<a name="l00105"></a>00105 
<a name="l00106"></a>00106                 pRow-&gt;<a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#aca31f0dd95c5db76467630ece52ecc48" title="gets value of URLSTAGE_ID.">Get_URLSTAGE_ID</a>(urlStageID);
<a name="l00107"></a>00107                 pRow-&gt;<a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a8474ada5ed4b0dbd8f9ce879c271f8ce" title="gets value of URL_ID.">Get_URL_ID</a>(urlID);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109                 sortedUrlStageIDs.push_back(urlStageID);
<a name="l00110"></a>00110                 mapUrlStageIDUrlID[urlStageID] = urlID;
<a name="l00111"></a>00111         }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         <span class="comment">//fetch title and description for pages</span>
<a name="l00114"></a>00114         std::map&lt;long long, PageInfo&gt; mapUrlStageIDPageInfo;
<a name="l00115"></a>00115         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4713d4037612a5a16ff3b38fb22bfe50">GetPageInfoByUrlStageID</a>(sortedUrlStageIDs, mapUrlStageIDPageInfo);
<a name="l00116"></a>00116 
<a name="l00117"></a>00117         <span class="comment">//fetch all urls</span>
<a name="l00118"></a>00118         std::vector&lt;long long&gt; urlIDs;
<a name="l00119"></a>00119         <a class="code" href="../../d6/d19/classtools_1_1ContainerTools.html#a10b5ce6dedb0a1774a4cce5a3a6f6b4b" title="converts second entry(value) of std::map to std::vector">tools::ContainerTools::Map2ToVector</a>(mapUrlStageIDUrlID,urlIDs);
<a name="l00120"></a>00120         std::map&lt;long long, htmlparser::DatabaseUrl&gt; mapUrls;
<a name="l00121"></a>00121         <a class="code" href="../../dd/d5e/classcaching_1_1CacheDatabaseUrl.html#a8a96fa1430ad97684ec8856b177f55a9" title="gets an url by an url-id and loads them from database if non-existing in cache.">caching::CacheDatabaseUrl::GetByUrlID</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>(),urlIDs,mapUrls);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="keywordflow">if</span>(mapUrls.size() == 0){
<a name="l00124"></a>00124                 <span class="comment">//no results found</span>
<a name="l00125"></a>00125                 <span class="keywordflow">return</span> <span class="keyword">true</span>; }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         <span class="comment">//fetch result count in case it is not set yet by SaveResults() function</span>
<a name="l00128"></a>00128         <span class="keywordflow">if</span>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#adc683ece48a6f24b23b8df70b7f7c3c9">countResults</a> == -1) {
<a name="l00129"></a>00129 
<a name="l00130"></a>00130                 std::vector&lt;database::WhereConditionTableColumn*&gt; whereContainerCount;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132                 <a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a7d5d8e4f7de00a3eabd8bd1cb11999b4" title="creates where condition for a value of SEARCHQUERY_ID.">database::queryresultsTableBase::GetWhereColumnsFor_SEARCHQUERY_ID</a>(
<a name="l00133"></a>00133                         <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a>(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a8f97bdd20995e906f92e9657958a0eb6">database::WhereCondition::InitialComp</a>()),
<a name="l00134"></a>00134                         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a0085f0e0633866ec7e7cc81c00fa1f7c">QueryID</a>(),
<a name="l00135"></a>00135                         whereContainerCount     );
<a name="l00136"></a>00136 
<a name="l00137"></a>00137                 <a class="code" href="../../d0/d6b/classdatabase_1_1TableColumnDefinition.html" title="class containing definition of a TableColumn.">database::TableColumnDefinition</a>* countColDef = <a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a39604f76164ca078bb1f6c5eec325aa6" title="create a column definition for column ID.">database::queryresultsTableBase::GetDefinition_ID</a>();
<a name="l00138"></a>00138                 <a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html" title="implements generic sql select statement.">database::SelectStatement</a> selectResultTotal(<a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a340f6361e6153ec98afe7e0170f33b5e" title="factory function for queryresults&#39;s table definition.">database::queryresultsTableBase::CreateTableDefinition</a>());
<a name="l00139"></a>00139                 selectResultTotal.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a6266e0a06387a0239976b199ea4af4db" title="creates a COUNT(column) column.">SelectAddCountColumn</a>(countColDef,<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;count_col&quot;</span>);
<a name="l00140"></a>00140                 selectResultTotal.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a2449145166e97f78a3a2428b06e0275c" title="gets where condition of this statement.">Where</a>().<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a958e50302a66209914132a02c57e2088" title="add multiple where conditions for multiple columns.">AddColumns</a>(whereContainerCount);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142                 <a class="code" href="../../df/dba/classdatabase_1_1SelectResultContainer.html" title="container for results of SELECT statements.">database::SelectResultContainer&lt;database::TableBase&gt;</a> resultsTotal;
<a name="l00143"></a>00143                 <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ac81a7a18a1b45a2a5809a923cdc91395" title="execute select statement.">Select</a>(selectResultTotal,resultsTotal);
<a name="l00144"></a>00144                 <span class="keywordflow">if</span>(resultsTotal.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1530b8ead15a2f1b821f4ef62c248c77" title="gets current container size.">Size</a>() != 1)
<a name="l00145"></a>00145                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147                 resultsTotal.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a384f051671e8058d5b9ed38e21dca16c" title="resets iterator.">ResetIter</a>();
<a name="l00148"></a>00148                 resultsTotal.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#ab6f7fab0c152ec5388a63ab94f52c3f6" title="gets current iterator.">GetIter</a>()-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;count_col&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#adc683ece48a6f24b23b8df70b7f7c3c9">countResults</a>);
<a name="l00149"></a>00149         }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a46ecfaa120fdec0822def19202ced0be">OutputResults</a>(sortedUrlStageIDs, mapUrlStageIDUrlID, mapUrlStageIDPageInfo, mapUrls);
<a name="l00152"></a>00152         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 
<a name="l00155"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a64bd5389d32e1e12ec34d33d1718478c">00155</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a64bd5389d32e1e12ec34d33d1718478c">XMLQueryResponse::ProcessNewQuery</a>(std::vector&lt;std::string&gt;&amp; vecKeywords)
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157         <span class="comment">//get ids for keywords</span>
<a name="l00158"></a>00158         std::map&lt;long long, KeywordEntry&gt; idKeywords;
<a name="l00159"></a>00159         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#abc772cdc721f078521e820fbee85055c">GetKeywordIDs</a>(vecKeywords,idKeywords);
<a name="l00160"></a>00160         <span class="keywordflow">if</span>(idKeywords.size()==0) {
<a name="l00161"></a>00161                 <span class="comment">//no keywords found</span>
<a name="l00162"></a>00162                 <span class="keywordflow">return</span> <span class="keyword">true</span>; }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         <span class="comment">//get relevant urls</span>
<a name="l00165"></a>00165         std::vector&lt;long long&gt; sortedUrlStageIDs;
<a name="l00166"></a>00166         std::map&lt;long long, long long&gt; mapUrlStageIDUrlID;
<a name="l00167"></a>00167         std::map&lt;long long, UrlStageEntry&gt; mapUrlStages;
<a name="l00168"></a>00168         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4633bd02b413a53760cf87a5bec461cc">GetResultsFromDatasources</a>(idKeywords, sortedUrlStageIDs, mapUrlStageIDUrlID, mapUrlStages);
<a name="l00169"></a>00169         <span class="keywordflow">if</span>(sortedUrlStageIDs.size()==0) {
<a name="l00170"></a>00170                 <span class="comment">//no results found</span>
<a name="l00171"></a>00171                 <span class="keywordflow">return</span> <span class="keyword">true</span>; }
<a name="l00172"></a>00172         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a480990b21b308115ca2cc3a5c3fa5479">SaveResults</a>(sortedUrlStageIDs, mapUrlStageIDUrlID);
<a name="l00173"></a>00173         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4633bd02b413a53760cf87a5bec461cc">00176</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4633bd02b413a53760cf87a5bec461cc">XMLQueryResponse::GetResultsFromDatasources</a>(
<a name="l00177"></a>00177                 <span class="keyword">const</span> std::map&lt;long long, KeywordEntry&gt;&amp; idKeywords,
<a name="l00178"></a>00178                 std::vector&lt;long long&gt;&amp; orderedUrlStages,
<a name="l00179"></a>00179                 std::map&lt;long long, long long&gt;&amp; mapUrlStageIDUrlID,
<a name="l00180"></a>00180                 std::map&lt;long long, UrlStageEntry&gt;&amp; mapUrlStages )
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182         std::vector&lt;long long&gt; sortedUrlStageIDs;
<a name="l00183"></a>00183         std::map&lt;long long, std::vector&lt;KeywordEntry&gt; &gt; idUrlStage;
<a name="l00184"></a>00184         std::map&lt;long long, BackLinkEntry&gt; urlStageIDBackLinks;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>&amp; critFlag = <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a39245b71c13989d7281734ce7d70284b">CriteriaFlag</a>();
<a name="l00187"></a>00187         <span class="keywordtype">bool</span> allFlags = critFlag &amp; <a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3b053109db44f429175972a3d1d9fea2a040cc2534881b964286318f6bf09ddf3">XMLQueryRequest::CRITERIA_ALL</a>;
<a name="l00188"></a>00188         <span class="keywordflow">if</span>( allFlags || ((critFlag &amp; <a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3b053109db44f429175972a3d1d9fea2a23843c5907728bca9d65c2f1b920e6a1">XMLQueryRequest::CRITERIA_META</a>) ||
<a name="l00189"></a>00189                 critFlag &amp; <a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3b053109db44f429175972a3d1d9fea2ae8f516a03fa7c8c3109791bc13e27816">XMLQueryRequest::CRITERIA_TITLE</a>) ){
<a name="l00190"></a>00190                 <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#ae712fb3aa3131457c60d90a0829f302b">GetPagesByMeta</a>(idKeywords, idUrlStage);}
<a name="l00191"></a>00191         <span class="keywordflow">if</span>( allFlags || (critFlag &amp; <a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3b053109db44f429175972a3d1d9fea2aadea05667ff2ccc147e0991e175f91c3">XMLQueryRequest::CRITERIA_DOMAIN</a>)){
<a name="l00192"></a>00192                 <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a9a20d3ca8a64b514617752a4493cf8ff">GetPagesByDomain</a>(idKeywords, idUrlStage);}
<a name="l00193"></a>00193         <span class="keywordflow">if</span>( allFlags || (critFlag &amp; <a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3b053109db44f429175972a3d1d9fea2a8103591502ab41f6c1a3ec1a977c0d06">XMLQueryRequest::CRITERIA_CONTENT</a>)){
<a name="l00194"></a>00194                 <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#aa476a2efec5c8346c0c52d35de9f36b9">GetPagesByContent</a>(idKeywords, idUrlStage);}
<a name="l00195"></a>00195         <span class="keywordflow">if</span>( allFlags || (critFlag &amp; <a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3b053109db44f429175972a3d1d9fea2a4ae5a8c54c25dbf7ae4cf1e0f7a06fb7">XMLQueryRequest::CRITERIA_PATH</a>)){
<a name="l00196"></a>00196                 <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4fb110f540766f229fd689f342650f87">GetPagesByUrlPath</a>(idKeywords, idUrlStage);}
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         std::map&lt;long long,UrlStageProperties&gt; mapUrlStageProperties;
<a name="l00199"></a>00199         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#af870c281773c4ab9fa340eb0d60c26a2">GetPageUrlStageInfo</a>(idUrlStage, mapUrlStageIDUrlID, mapUrlStageProperties);
<a name="l00200"></a>00200 
<a name="l00201"></a>00201         <span class="keywordflow">if</span>(mapUrlStages.size()) {
<a name="l00202"></a>00202                 <span class="keywordflow">if</span>( allFlags || (critFlag &amp; <a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3b053109db44f429175972a3d1d9fea2a9cf4811b19eb1e396a8dd5f661f33a9f">XMLQueryRequest::CRITERIA_LINKS</a>)) {
<a name="l00203"></a>00203                         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a877f6d3d72ac398dbe569ee546ed2fec">GetPageRelevanceByBacklinks</a>(mapUrlStageIDUrlID, urlStageIDBackLinks); }
<a name="l00204"></a>00204         }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="comment">//assemble url list</span>
<a name="l00207"></a>00207         std::map&lt;long long,UrlStageProperties&gt;::const_iterator iterStageProperties = mapUrlStageProperties.begin();
<a name="l00208"></a>00208         <span class="keywordflow">for</span>(;iterStageProperties != mapUrlStageProperties.end();++iterStageProperties){
<a name="l00209"></a>00209                 <span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlStageID = iterStageProperties-&gt;first;
<a name="l00210"></a>00210                 <span class="keywordflow">if</span>(mapUrlStageProperties.count(urlStageID) == 0) {
<a name="l00211"></a>00211                         <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba907c124e854af2340f7b1bfa1b28bc5b" title="warnings">log::Logging::LOGLEVEL_WARN</a>, <span class="stringliteral">&quot;could not find urlstage properties&quot;</span>);
<a name="l00212"></a>00212                         <span class="keywordflow">continue</span>; }
<a name="l00213"></a>00213                 <span class="keyword">const</span> <a class="code" href="../../df/de7/classqueryserver_1_1UrlStageProperties.html">UrlStageProperties</a>&amp; stageProperties = mapUrlStageProperties.at(urlStageID);
<a name="l00214"></a>00214                 <span class="keyword">const</span> std::vector&lt;KeywordEntry&gt;&amp; keywords = idUrlStage[urlStageID];
<a name="l00215"></a>00215                 <span class="keyword">const</span> <a class="code" href="../../d2/d09/classqueryserver_1_1BackLinkEntry.html">BackLinkEntry</a>&amp; backlinkEntry = urlStageIDBackLinks[urlStageID];
<a name="l00216"></a>00216                 mapUrlStages.insert(std::pair&lt;long long,UrlStageEntry&gt;(urlStageID, <a class="code" href="../../d2/d92/classqueryserver_1_1UrlStageEntry.html">UrlStageEntry</a>(stageProperties,keywords,backlinkEntry)));
<a name="l00217"></a>00217         }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219         std::map&lt;long long, Relevance&gt; urlStageRelevance;
<a name="l00220"></a>00220         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a2bca896347f8bf19e235defb0ca01ffe">SortResults</a>(mapUrlStages, urlStageIDBackLinks, sortedUrlStageIDs,urlStageRelevance);
<a name="l00221"></a>00221         <a class="code" href="../../d3/dcf/classqueryserver_1_1XMLQueryResponse_1_1OrderedResults.html">OrderedResults</a> orderedResults;
<a name="l00222"></a>00222         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a36ca38d834de7906a85bf96be70c1c73">GroupResults</a>(mapUrlStages, sortedUrlStageIDs,orderedResults);
<a name="l00223"></a>00223 
<a name="l00224"></a>00224         <span class="comment">//TODO: !!!dirty hack, do not copy here!!!!</span>
<a name="l00225"></a>00225         orderedUrlStages = orderedResults.<a class="code" href="../../d3/dcf/classqueryserver_1_1XMLQueryResponse_1_1OrderedResults.html#aea550b4d50b77223a028f5e4daf4d22f">sortedUrlStageIDs</a>;
<a name="l00226"></a>00226         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 
<a name="l00229"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#ae712fb3aa3131457c60d90a0829f302b">00229</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#ae712fb3aa3131457c60d90a0829f302b">XMLQueryResponse::GetPagesByMeta</a>(<span class="keyword">const</span> std::map&lt;long long, KeywordEntry&gt;&amp; idKeywords, std::map&lt;<span class="keywordtype">long</span> <span class="keywordtype">long</span>, std::vector&lt;KeywordEntry&gt; &gt;&amp; idUrlStage )
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231         std::vector&lt;database::WhereConditionTableColumn*&gt; whereContainer;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233         std::vector&lt;long long&gt; idKeywordVector;
<a name="l00234"></a>00234         <a class="code" href="../../d6/d19/classtools_1_1ContainerTools.html#aa3319436a0b504fbc8c830d6b82b9f07" title="converts first entry(key) of std::map to std::vector">tools::ContainerTools::Map1ToVector</a>(idKeywords,idKeywordVector);
<a name="l00235"></a>00235         <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a> paramDict(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a8f97bdd20995e906f92e9657958a0eb6">database::WhereCondition::InitialComp</a>());
<a name="l00236"></a>00236         paramDict.<a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html#af9c9841b96277f41a315f8f5fe8fefb3" title="alias table name.">tableNameAlias</a> = <span class="stringliteral">&quot;theDocMeta&quot;</span>;
<a name="l00237"></a>00237         <a class="code" href="../../d7/d19/classdatabase_1_1docmetaTableBase.html#aeecb51a27bbe88bb2377855ec8f1665a" title="creates where condition for a value of DICT_ID.">database::docmetaTableBase::GetWhereColumnsFor_DICT_ID</a>(
<a name="l00238"></a>00238                 paramDict,
<a name="l00239"></a>00239                 idKeywordVector,
<a name="l00240"></a>00240                 whereContainer);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>&amp; critFlag = <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a39245b71c13989d7281734ce7d70284b">CriteriaFlag</a>();
<a name="l00243"></a>00243         <span class="keywordflow">if</span> ((critFlag &amp; <a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3b053109db44f429175972a3d1d9fea2a23843c5907728bca9d65c2f1b920e6a1">XMLQueryRequest::CRITERIA_META</a>) &amp;&amp;
<a name="l00244"></a>00244             (critFlag &amp; <a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3b053109db44f429175972a3d1d9fea2ae8f516a03fa7c8c3109791bc13e27816">XMLQueryRequest::CRITERIA_TITLE</a>)) {
<a name="l00245"></a>00245                 <span class="comment">//we want to select all types</span>
<a name="l00246"></a>00246         }
<a name="l00247"></a>00247         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (critFlag &amp; XMLQueryRequest::CRITERIA_META) {
<a name="l00248"></a>00248                 std::vector&lt;long long&gt; vecTypes;
<a name="l00249"></a>00249                 vecTypes.push_back(1);
<a name="l00250"></a>00250                 vecTypes.push_back(2);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252                 <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a> paramMeta(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#ab74611e18cb57252673663bb5e2ff6de">database::WhereCondition::And</a>());
<a name="l00253"></a>00253                 paramMeta.<a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html#af9c9841b96277f41a315f8f5fe8fefb3" title="alias table name.">tableNameAlias</a> = <span class="stringliteral">&quot;theDocMeta&quot;</span>;
<a name="l00254"></a>00254                 <a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html#a70f373e290004722eeed0bb74e7f9f32" title="creates where condition for a value of type.">database::metainfoTableBase::GetWhereColumnsFor_type</a>(
<a name="l00255"></a>00255                         paramMeta,
<a name="l00256"></a>00256                         vecTypes,
<a name="l00257"></a>00257                         whereContainer);
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (critFlag &amp; XMLQueryRequest::CRITERIA_TITLE) {
<a name="l00260"></a>00260                 <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a> paramMeta(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#ab74611e18cb57252673663bb5e2ff6de">database::WhereCondition::And</a>());
<a name="l00261"></a>00261                 paramMeta.<a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html#af9c9841b96277f41a315f8f5fe8fefb3" title="alias table name.">tableNameAlias</a> = <span class="stringliteral">&quot;theDocMeta&quot;</span>;
<a name="l00262"></a>00262                 <a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html#a70f373e290004722eeed0bb74e7f9f32" title="creates where condition for a value of type.">database::metainfoTableBase::GetWhereColumnsFor_type</a>(
<a name="l00263"></a>00263                         paramMeta,
<a name="l00264"></a>00264                         3,
<a name="l00265"></a>00265                         whereContainer);
<a name="l00266"></a>00266         }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         <a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html" title="implements generic sql select statement.">database::SelectStatement</a> docMeta(<a class="code" href="../../d7/d19/classdatabase_1_1docmetaTableBase.html#a698b260ac75f2a562d5ab80a56b06ae9" title="factory function for docmeta&#39;s table definition.">database::docmetaTableBase::CreateTableDefinition</a>(),<span class="stringliteral">&quot;theDocMeta&quot;</span>);
<a name="l00269"></a>00269         docMeta.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#ad4576687383c4de60705747802b24280" title="selects all columns of statement&#39;s table.">SelectAllColumns</a>();
<a name="l00270"></a>00270         docMeta.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a2449145166e97f78a3a2428b06e0275c" title="gets where condition of this statement.">Where</a>().<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a958e50302a66209914132a02c57e2088" title="add multiple where conditions for multiple columns.">AddColumns</a>(whereContainer);
<a name="l00271"></a>00271         docMeta.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a650aec0d1b7e74a456e62c0a514e028d" title="gets order by clause of this statement.">OrderBy</a>().<a class="code" href="../../dc/dc8/classdatabase_1_1OrderByClause.html#a5ce495eec08d255060a624788a8bd66d" title="add column to order by.">AddColumn</a>(<a class="code" href="../../d7/d19/classdatabase_1_1docmetaTableBase.html#a7a6213b0c57a2fdbeae5755a330e7e3c" title="create a column definition for column occurrence.">database::docmetaTableBase::GetDefinition_occurrence</a>(),<a class="code" href="../../da/df2/namespacedatabase.html#af93a39435af4e48debe6d634403174f6ad6b6d9cc5e0111e64fcc8a14032b7d01" title="descending order.">database::DESCENDING</a>,<span class="stringliteral">&quot;theDocMeta&quot;</span>,<span class="stringliteral">&quot;occurrence&quot;</span>);
<a name="l00272"></a>00272 
<a name="l00273"></a>00273         <a class="code" href="../../d7/d19/classdatabase_1_1docmetaTableBase.html#a96698bdd016fe8394d32323c345863d6">database::docmetaTableBase::AddInnerJoinRightSideOn_URLSTAGE_ID</a>(<span class="stringliteral">&quot;theDocMeta&quot;</span>, <span class="stringliteral">&quot;URLSTAGE_ID&quot;</span>, <span class="stringliteral">&quot;theStage&quot;</span>, <span class="stringliteral">&quot;ID&quot;</span>, docMeta);
<a name="l00274"></a>00274         <a class="code" href="../../d1/da6/classdatabase_1_1latesturlstagesTableBase.html#ab40f6e71b93c8893177cd5b847dd2ef3">database::latesturlstagesTableBase::AddInnerJoinLeftSideOn_URLSTAGE_ID</a>(<span class="stringliteral">&quot;theLatest&quot;</span>, <span class="stringliteral">&quot;URLSTAGE_ID&quot;</span>, <span class="stringliteral">&quot;theStage&quot;</span>, <span class="stringliteral">&quot;ID&quot;</span>, docMeta);
<a name="l00275"></a>00275         <a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html#a2365349c77ffb6f346fd8492f7626494">database::metainfoTableBase::AddInnerJoinLeftSideOn_URLSTAGE_ID</a>(<span class="stringliteral">&quot;theMetaInfo&quot;</span>, <span class="stringliteral">&quot;URLSTAGE_ID&quot;</span>, <span class="stringliteral">&quot;theStage&quot;</span>, <span class="stringliteral">&quot;ID&quot;</span>, docMeta);
<a name="l00276"></a>00276 
<a name="l00277"></a>00277         <a class="code" href="../../df/dba/classdatabase_1_1SelectResultContainer.html" title="container for results of SELECT statements.">database::SelectResultContainer&lt;database::docmetaTableBase&gt;</a> vecDocMeta;
<a name="l00278"></a>00278         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ac81a7a18a1b45a2a5809a923cdc91395" title="execute select statement.">Select</a>(docMeta,vecDocMeta);
<a name="l00279"></a>00279         <span class="keywordflow">if</span>( vecDocMeta.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1530b8ead15a2f1b821f4ef62c248c77" title="gets current container size.">Size</a>() == 0 ) {
<a name="l00280"></a>00280                 <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         vecDocMeta.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a384f051671e8058d5b9ed38e21dca16c" title="resets iterator.">ResetIter</a>();
<a name="l00283"></a>00283         <span class="keywordflow">for</span>(;!vecDocMeta.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a7c7e995e6f634648f8e02dd139f60737" title="checks if iterator is at end.">IsIterEnd</a>(); vecDocMeta.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1b1ed522439feadf4836dea1ad3bc1ff" title="increment iterator.">Next</a>()) {
<a name="l00284"></a>00284                 <span class="comment">//TODO: maybe set weight</span>
<a name="l00285"></a>00285                 <span class="keywordtype">double</span> weight = 1.0;
<a name="l00286"></a>00286                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlStageID = -1, dictID = -1, occurrence = -1;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288                 <a class="code" href="../../d7/d19/classdatabase_1_1docmetaTableBase.html" title="wrapper class for database table docmeta">database::docmetaTableBase</a>* pRow = vecDocMeta.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#ab6f7fab0c152ec5388a63ab94f52c3f6" title="gets current iterator.">GetIter</a>();
<a name="l00289"></a>00289 
<a name="l00290"></a>00290                 pRow-&gt;<a class="code" href="../../d7/d19/classdatabase_1_1docmetaTableBase.html#aa6a8e5327917389fea2abf5d7e2b8bd7" title="gets value of URLSTAGE_ID.">Get_URLSTAGE_ID</a>(urlStageID);
<a name="l00291"></a>00291                 pRow-&gt;<a class="code" href="../../d7/d19/classdatabase_1_1docmetaTableBase.html#a62da38f10f188aa57b01841dec7b49b3" title="gets value of DICT_ID.">Get_DICT_ID</a>(dictID);
<a name="l00292"></a>00292                 pRow-&gt;<a class="code" href="../../d7/d19/classdatabase_1_1docmetaTableBase.html#ae09f78cee0f8b3385aa76cee859b60e5" title="gets value of occurrence.">Get_occurrence</a>(occurrence);
<a name="l00293"></a>00293 
<a name="l00294"></a>00294                 std::map&lt;long long, KeywordEntry&gt;::const_iterator posKeyword = idKeywords.find(dictID);
<a name="l00295"></a>00295                 <span class="keywordflow">if</span>(posKeyword == idKeywords.end()) {
<a name="l00296"></a>00296                         <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba629f976f682f75c5279ad61bcf7f306e" title="errors">log::Logging::LOGLEVEL_ERROR</a>,<span class="stringliteral">&quot;could not find keyword matching for meta information&quot;</span>);
<a name="l00297"></a>00297                         <span class="keywordflow">continue</span>; }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299                 idUrlStage[urlStageID].push_back(
<a name="l00300"></a>00300                         <a class="code" href="../../d3/de1/classqueryserver_1_1KeywordEntry.html">KeywordEntry</a>(<a class="code" href="../../d3/de1/classqueryserver_1_1KeywordEntry.html#afe7fdf97974af4ba7566d61172217cc9a6b502482afdd2bd8606eeddbbdd03b89">KeywordEntry::META_KEYWORD_TYPE</a>, <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a437fce298ec3be354ab2faf5d02bb56b">MetaRelevance</a>(), weight, posKeyword-&gt;second.GetKeyword(), dictID, occurrence)
<a name="l00301"></a>00301                 );
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a9a20d3ca8a64b514617752a4493cf8ff">00306</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a9a20d3ca8a64b514617752a4493cf8ff">XMLQueryResponse::GetPagesByDomain</a>(<span class="keyword">const</span> std::map&lt;long long, KeywordEntry&gt;&amp; idKeywords, std::map&lt;<span class="keywordtype">long</span> <span class="keywordtype">long</span>, std::vector&lt;KeywordEntry&gt; &gt;&amp; idUrlStage )
<a name="l00307"></a>00307 {
<a name="l00308"></a>00308         std::vector&lt;KeywordEntry&gt; entries;
<a name="l00309"></a>00309         <a class="code" href="../../d6/d19/classtools_1_1ContainerTools.html#a10b5ce6dedb0a1774a4cce5a3a6f6b4b" title="converts second entry(value) of std::map to std::vector">tools::ContainerTools::Map2ToVector</a>(idKeywords,entries);
<a name="l00310"></a>00310         std::vector&lt;KeywordEntry&gt;::const_iterator iterEntries = entries.begin();
<a name="l00311"></a>00311         std::vector&lt;std::string&gt; keywordsLC;
<a name="l00312"></a>00312         <span class="keywordflow">for</span>(;iterEntries != entries.end();++iterEntries) {
<a name="l00313"></a>00313                 keywordsLC.push_back(<a class="code" href="../../de/d7e/classtools_1_1StringTools.html#a2d783976012a303d394b0a13f8926865" title="lowers string.">tools::StringTools::ToLowerNP</a>(iterEntries-&gt;GetKeyword())); }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <a class="code" href="../../df/dba/classdatabase_1_1SelectResultContainer.html" title="container for results of SELECT statements.">database::SelectResultContainer&lt;database::secondleveldomainsTableBase&gt;</a> resSnd;
<a name="l00316"></a>00316         <a class="code" href="../../d4/da8/classdatabase_1_1secondleveldomainsTableBase.html#a1feba10bae595c6a8729c9fa6837dd26" title="gets rows by a value of domain.">database::secondleveldomainsTableBase::GetBy_domain</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>(),keywordsLC,resSnd);
<a name="l00317"></a>00317         <span class="keywordflow">if</span>(resSnd.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1530b8ead15a2f1b821f4ef62c248c77" title="gets current container size.">Size</a>() == 0) {
<a name="l00318"></a>00318                 <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320         std::map&lt;long long,std::string&gt; mapSecondLevelIDKeyword;
<a name="l00321"></a>00321         resSnd.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a384f051671e8058d5b9ed38e21dca16c" title="resets iterator.">ResetIter</a>();
<a name="l00322"></a>00322         <span class="keywordflow">for</span>(;!resSnd.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a7c7e995e6f634648f8e02dd139f60737" title="checks if iterator is at end.">IsIterEnd</a>();resSnd.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1b1ed522439feadf4836dea1ad3bc1ff" title="increment iterator.">Next</a>()) {
<a name="l00323"></a>00323                 <a class="code" href="../../d4/da8/classdatabase_1_1secondleveldomainsTableBase.html" title="wrapper class for database table secondleveldomains">database::secondleveldomainsTableBase</a>* pRow = resSnd.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#ab6f7fab0c152ec5388a63ab94f52c3f6" title="gets current iterator.">GetIter</a>();
<a name="l00324"></a>00324                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> sndID = -1;
<a name="l00325"></a>00325                 std::string domain;
<a name="l00326"></a>00326                 pRow-&gt;<a class="code" href="../../d4/da8/classdatabase_1_1secondleveldomainsTableBase.html#a7879c5589459a753a9841b079f90c5bc" title="gets value of ID.">Get_ID</a>(sndID);
<a name="l00327"></a>00327                 pRow-&gt;<a class="code" href="../../d4/da8/classdatabase_1_1secondleveldomainsTableBase.html#ae5f801db180b5d385d3b01e03a31c8fa" title="gets value of domain.">Get_domain</a>(domain);
<a name="l00328"></a>00328                 mapSecondLevelIDKeyword[sndID] = domain; }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330         std::vector&lt;long long&gt; secondLevelID;
<a name="l00331"></a>00331         <a class="code" href="../../d6/d19/classtools_1_1ContainerTools.html#aa3319436a0b504fbc8c830d6b82b9f07" title="converts first entry(key) of std::map to std::vector">tools::ContainerTools::Map1ToVector</a>(mapSecondLevelIDKeyword,secondLevelID);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333         std::vector&lt;database::WhereConditionTableColumn*&gt; whereContainer;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335         <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a> paramSecondLevel(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a8f97bdd20995e906f92e9657958a0eb6">database::WhereCondition::InitialComp</a>());
<a name="l00336"></a>00336         paramSecondLevel.<a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html#af9c9841b96277f41a315f8f5fe8fefb3" title="alias table name.">tableNameAlias</a> = <span class="stringliteral">&quot;theUrls&quot;</span>;
<a name="l00337"></a>00337         <a class="code" href="../../dc/d71/classdatabase_1_1urlsTableBase.html#a56df7d98e3bf7df622087079a1e650ae" title="creates where condition for a value of SECONDLEVELDOMAIN_ID.">database::urlsTableBase::GetWhereColumnsFor_SECONDLEVELDOMAIN_ID</a>(
<a name="l00338"></a>00338                 paramSecondLevel,
<a name="l00339"></a>00339                 secondLevelID,
<a name="l00340"></a>00340                 whereContainer );
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         <a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html" title="implements generic sql select statement.">database::SelectStatement</a> selectUrlStages(<a class="code" href="../../dc/d71/classdatabase_1_1urlsTableBase.html#aba900e1b0d4f8a93626df2f987d97f5c" title="factory function for urls&#39;s table definition.">database::urlsTableBase::CreateTableDefinition</a>(),<span class="stringliteral">&quot;theUrls&quot;</span>);
<a name="l00343"></a>00343         selectUrlStages.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#ad4576687383c4de60705747802b24280" title="selects all columns of statement&#39;s table.">SelectAllColumns</a>();
<a name="l00344"></a>00344         selectUrlStages.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a182e67cdbf2ab279ced5084f2e6bc82a" title="adds single column.">SelectAddColumn</a>(<a class="code" href="../../d1/da6/classdatabase_1_1latesturlstagesTableBase.html#a40c89fd823e0e7f814208e4032843aeb" title="create a column definition for column URLSTAGE_ID.">database::latesturlstagesTableBase::GetDefinition_URLSTAGE_ID</a>(),<span class="stringliteral">&quot;theLatest&quot;</span>,<span class="stringliteral">&quot;URLSTAGE_ID&quot;</span>);
<a name="l00345"></a>00345         selectUrlStages.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a2449145166e97f78a3a2428b06e0275c" title="gets where condition of this statement.">Where</a>().<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a958e50302a66209914132a02c57e2088" title="add multiple where conditions for multiple columns.">AddColumns</a>(whereContainer);
<a name="l00346"></a>00346         <a class="code" href="../../d1/da6/classdatabase_1_1latesturlstagesTableBase.html#a46c131382bdcafd3d1cfc7dab3f12444">database::latesturlstagesTableBase::AddInnerJoinLeftSideOn_URL_ID</a>(<span class="stringliteral">&quot;theLatest&quot;</span>,<span class="stringliteral">&quot;URL_ID&quot;</span>,<span class="stringliteral">&quot;theUrls&quot;</span>,<span class="stringliteral">&quot;ID&quot;</span>,selectUrlStages);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348         <a class="code" href="../../df/dba/classdatabase_1_1SelectResultContainer.html" title="container for results of SELECT statements.">database::SelectResultContainer&lt;database::TableBase&gt;</a> vecRows;
<a name="l00349"></a>00349         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ac81a7a18a1b45a2a5809a923cdc91395" title="execute select statement.">Select</a>(selectUrlStages,vecRows);
<a name="l00350"></a>00350         <span class="keywordflow">if</span>( vecRows.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1530b8ead15a2f1b821f4ef62c248c77" title="gets current container size.">Size</a>() == 0 ) {
<a name="l00351"></a>00351                 <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         vecRows.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a384f051671e8058d5b9ed38e21dca16c" title="resets iterator.">ResetIter</a>();
<a name="l00354"></a>00354         <span class="keywordflow">for</span>(;!vecRows.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a7c7e995e6f634648f8e02dd139f60737" title="checks if iterator is at end.">IsIterEnd</a>();vecRows.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1b1ed522439feadf4836dea1ad3bc1ff" title="increment iterator.">Next</a>()) {
<a name="l00355"></a>00355                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> secondLevelDomain = -1;
<a name="l00356"></a>00356                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlID = -1, urlStageID = -1;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358                 <span class="keyword">const</span> <a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html" title="implements generic table row class.">database::TableBase</a>* pRow = vecRows.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#ab6f7fab0c152ec5388a63ab94f52c3f6" title="gets current iterator.">GetIter</a>();
<a name="l00359"></a>00359 
<a name="l00360"></a>00360                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;SECONDLEVELDOMAIN_ID&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(secondLevelDomain);
<a name="l00361"></a>00361                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;ID&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(urlID);
<a name="l00362"></a>00362                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;URLSTAGE_ID&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(urlStageID);
<a name="l00363"></a>00363 
<a name="l00364"></a>00364                 std::map&lt;long long, std::string&gt;::const_iterator posKeyword = mapSecondLevelIDKeyword.find(secondLevelDomain);
<a name="l00365"></a>00365                 <span class="keywordflow">if</span>(posKeyword == mapSecondLevelIDKeyword.end()) {
<a name="l00366"></a>00366                         <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba629f976f682f75c5279ad61bcf7f306e" title="errors">log::Logging::LOGLEVEL_ERROR</a>,<span class="stringliteral">&quot;could not find keyword matching for domain information&quot;</span>);
<a name="l00367"></a>00367                         <span class="keywordflow">continue</span>; }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369                 idUrlStage[urlStageID].push_back(
<a name="l00370"></a>00370                         <a class="code" href="../../d3/de1/classqueryserver_1_1KeywordEntry.html">KeywordEntry</a>(<a class="code" href="../../d3/de1/classqueryserver_1_1KeywordEntry.html#afe7fdf97974af4ba7566d61172217cc9a28d946cb04389ffe81c34ff4df114d2e">KeywordEntry::DOMAIN_KEYWORD_TYPE</a>, <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#ad1afe405d309a64f010baa1ff39c5715">DomainRelevance</a>(), 1.0, posKeyword-&gt;second, -1, 1)
<a name="l00371"></a>00371                 );
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#aa476a2efec5c8346c0c52d35de9f36b9">00376</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#aa476a2efec5c8346c0c52d35de9f36b9">XMLQueryResponse::GetPagesByContent</a>(<span class="keyword">const</span> std::map&lt;long long, KeywordEntry&gt;&amp; idKeywords, std::map&lt;<span class="keywordtype">long</span> <span class="keywordtype">long</span>, std::vector&lt;KeywordEntry&gt; &gt;&amp; idUrlStage )
<a name="l00377"></a>00377 {
<a name="l00378"></a>00378         std::vector&lt;database::WhereConditionTableColumn*&gt; whereContainer;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         std::vector&lt;long long&gt; idKeywordVector;
<a name="l00381"></a>00381         <a class="code" href="../../d6/d19/classtools_1_1ContainerTools.html#aa3319436a0b504fbc8c830d6b82b9f07" title="converts first entry(key) of std::map to std::vector">tools::ContainerTools::Map1ToVector</a>(idKeywords,idKeywordVector);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383         <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a> dictParam(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a8f97bdd20995e906f92e9657958a0eb6">database::WhereCondition::InitialComp</a>());
<a name="l00384"></a>00384         dictParam.<a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html#af9c9841b96277f41a315f8f5fe8fefb3" title="alias table name.">tableNameAlias</a> = <span class="stringliteral">&quot;theDocKey&quot;</span>;
<a name="l00385"></a>00385         <a class="code" href="../../d7/d8f/classdatabase_1_1dockeyTableBase.html#aea0ade2a820413bcd0e3dd8faefdd74a" title="creates where condition for a value of DICT_ID.">database::dockeyTableBase::GetWhereColumnsFor_DICT_ID</a>(
<a name="l00386"></a>00386                 dictParam,
<a name="l00387"></a>00387                 idKeywordVector,
<a name="l00388"></a>00388                 whereContainer );
<a name="l00389"></a>00389 
<a name="l00390"></a>00390         <a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html" title="implements generic sql select statement.">database::SelectStatement</a> dockeyInfo(<a class="code" href="../../d7/d8f/classdatabase_1_1dockeyTableBase.html#a4c5c0af8fc1f3bcdb952f6de1e8eb3e5" title="factory function for dockey&#39;s table definition.">database::dockeyTableBase::CreateTableDefinition</a>(),<span class="stringliteral">&quot;theDocKey&quot;</span>);
<a name="l00391"></a>00391         dockeyInfo.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#ad4576687383c4de60705747802b24280" title="selects all columns of statement&#39;s table.">SelectAllColumns</a>();
<a name="l00392"></a>00392         dockeyInfo.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a2449145166e97f78a3a2428b06e0275c" title="gets where condition of this statement.">Where</a>().<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a958e50302a66209914132a02c57e2088" title="add multiple where conditions for multiple columns.">AddColumns</a>(whereContainer);
<a name="l00393"></a>00393         dockeyInfo.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a650aec0d1b7e74a456e62c0a514e028d" title="gets order by clause of this statement.">OrderBy</a>().<a class="code" href="../../dc/dc8/classdatabase_1_1OrderByClause.html#a5ce495eec08d255060a624788a8bd66d" title="add column to order by.">AddColumn</a>(<a class="code" href="../../d7/d8f/classdatabase_1_1dockeyTableBase.html#ae8fa5520a4fc21b50970291b919946a7" title="create a column definition for column occurrence.">database::dockeyTableBase::GetDefinition_occurrence</a>(), <a class="code" href="../../da/df2/namespacedatabase.html#af93a39435af4e48debe6d634403174f6ad6b6d9cc5e0111e64fcc8a14032b7d01" title="descending order.">database::DESCENDING</a>);
<a name="l00394"></a>00394         <a class="code" href="../../d7/d8f/classdatabase_1_1dockeyTableBase.html#add9c2197c8da8c1d780853cda14da2fd">database::dockeyTableBase::AddInnerJoinRightSideOn_URLSTAGE_ID</a>(<span class="stringliteral">&quot;theDocKey&quot;</span>, <span class="stringliteral">&quot;URLSTAGE_ID&quot;</span> ,<span class="stringliteral">&quot;theStage&quot;</span>, <span class="stringliteral">&quot;ID&quot;</span>, dockeyInfo);
<a name="l00395"></a>00395         <a class="code" href="../../d1/da6/classdatabase_1_1latesturlstagesTableBase.html#ab40f6e71b93c8893177cd5b847dd2ef3">database::latesturlstagesTableBase::AddInnerJoinLeftSideOn_URLSTAGE_ID</a>(<span class="stringliteral">&quot;theLatest&quot;</span>, <span class="stringliteral">&quot;URLSTAGE_ID&quot;</span>, <span class="stringliteral">&quot;theStage&quot;</span>, <span class="stringliteral">&quot;ID&quot;</span> ,dockeyInfo);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         <a class="code" href="../../df/dba/classdatabase_1_1SelectResultContainer.html" title="container for results of SELECT statements.">database::SelectResultContainer&lt;database::dockeyTableBase&gt;</a> vecDocKey;
<a name="l00398"></a>00398         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ac81a7a18a1b45a2a5809a923cdc91395" title="execute select statement.">Select</a>(dockeyInfo,vecDocKey);
<a name="l00399"></a>00399         <span class="keywordflow">if</span>( vecDocKey.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1530b8ead15a2f1b821f4ef62c248c77" title="gets current container size.">Size</a>() == 0 ) {
<a name="l00400"></a>00400                 <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402         vecDocKey.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a384f051671e8058d5b9ed38e21dca16c" title="resets iterator.">ResetIter</a>();
<a name="l00403"></a>00403         <span class="keywordflow">for</span>(;!vecDocKey.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a7c7e995e6f634648f8e02dd139f60737" title="checks if iterator is at end.">IsIterEnd</a>();vecDocKey.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1b1ed522439feadf4836dea1ad3bc1ff" title="increment iterator.">Next</a>()) {
<a name="l00404"></a>00404 
<a name="l00405"></a>00405                 <a class="code" href="../../d7/d8f/classdatabase_1_1dockeyTableBase.html" title="wrapper class for database table dockey">database::dockeyTableBase</a>* pRow = vecDocKey.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#ab6f7fab0c152ec5388a63ab94f52c3f6" title="gets current iterator.">GetIter</a>();
<a name="l00406"></a>00406 
<a name="l00407"></a>00407                 <span class="comment">//TODO: maybe set weight</span>
<a name="l00408"></a>00408                 <span class="keywordtype">double</span> weight = 1.0;
<a name="l00409"></a>00409                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlStageID = -1, dictID = -1, occurrence = -1;
<a name="l00410"></a>00410                 pRow-&gt;<a class="code" href="../../d7/d8f/classdatabase_1_1dockeyTableBase.html#ac9f1ef0a2355cbdc363347a58d09a329" title="gets value of URLSTAGE_ID.">Get_URLSTAGE_ID</a>(urlStageID);
<a name="l00411"></a>00411                 pRow-&gt;<a class="code" href="../../d7/d8f/classdatabase_1_1dockeyTableBase.html#a9b5938b3f890e2aaee0ae84923d17b4e" title="gets value of DICT_ID.">Get_DICT_ID</a>(dictID);
<a name="l00412"></a>00412                 pRow-&gt;<a class="code" href="../../d7/d8f/classdatabase_1_1dockeyTableBase.html#ab1a8971f6bd55e51a56a4050ff54c680" title="gets value of occurrence.">Get_occurrence</a>(occurrence);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414                 std::map&lt;long long, KeywordEntry&gt;::const_iterator posKeyword = idKeywords.find(dictID);
<a name="l00415"></a>00415                 <span class="keywordflow">if</span>(posKeyword == idKeywords.end()) {
<a name="l00416"></a>00416                         <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba629f976f682f75c5279ad61bcf7f306e" title="errors">log::Logging::LOGLEVEL_ERROR</a>,<span class="stringliteral">&quot;could not find keyword matching for content information&quot;</span>);
<a name="l00417"></a>00417                         <span class="keywordflow">continue</span>; }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419                 idUrlStage[urlStageID].push_back(
<a name="l00420"></a>00420                         <a class="code" href="../../d3/de1/classqueryserver_1_1KeywordEntry.html">KeywordEntry</a>(<a class="code" href="../../d3/de1/classqueryserver_1_1KeywordEntry.html#afe7fdf97974af4ba7566d61172217cc9a1a3738add9e77c35bbf29dc1bec2f0e6">KeywordEntry::CONTENT_KEYWORD_TYPE</a>, <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a4607d6ddf935a6dcde5f1e08ce3920f1">ContentRelevance</a>(), weight, posKeyword-&gt;second.GetKeyword(), dictID, occurrence)
<a name="l00421"></a>00421                 );
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#abc772cdc721f078521e820fbee85055c">00426</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#abc772cdc721f078521e820fbee85055c">XMLQueryResponse::GetKeywordIDs</a>(<span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; vecKeywords, std::map&lt;long long, KeywordEntry&gt;&amp; idKeywords)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428         std::vector&lt;database::WhereConditionTableColumn*&gt; whereContainer;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430         <a class="code" href="../../db/dfa/classdatabase_1_1dictTableBase.html#ad918373a3f51bbc73d4bcaa61589cf1f" title="creates where condition for a value of keyword.">database::dictTableBase::GetWhereColumnsFor_keyword</a>(
<a name="l00431"></a>00431                 <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a>(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#aedbeca1e40a27dce579b7b990d46127f">database::WhereCondition::Like</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a8f97bdd20995e906f92e9657958a0eb6">database::WhereCondition::InitialComp</a>()),
<a name="l00432"></a>00432                 vecKeywords,
<a name="l00433"></a>00433                 whereContainer );
<a name="l00434"></a>00434 
<a name="l00435"></a>00435         <a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html" title="implements generic sql select statement.">database::SelectStatement</a> selectKeyWord(<a class="code" href="../../db/dfa/classdatabase_1_1dictTableBase.html#a15e0a8a5c11a5902385d5ab8a5c7ce12" title="factory function for dict&#39;s table definition.">database::dictTableBase::CreateTableDefinition</a>());
<a name="l00436"></a>00436         selectKeyWord.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#ad4576687383c4de60705747802b24280" title="selects all columns of statement&#39;s table.">SelectAllColumns</a>();
<a name="l00437"></a>00437         selectKeyWord.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a2449145166e97f78a3a2428b06e0275c" title="gets where condition of this statement.">Where</a>().<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a958e50302a66209914132a02c57e2088" title="add multiple where conditions for multiple columns.">AddColumns</a>(whereContainer);
<a name="l00438"></a>00438         selectKeyWord.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a650aec0d1b7e74a456e62c0a514e028d" title="gets order by clause of this statement.">OrderBy</a>().<a class="code" href="../../dc/dc8/classdatabase_1_1OrderByClause.html#a5ce495eec08d255060a624788a8bd66d" title="add column to order by.">AddColumn</a>(<a class="code" href="../../db/dfa/classdatabase_1_1dictTableBase.html#a332197b49f8dc24757be9d472c79a83b" title="create a column definition for column occurrence.">database::dictTableBase::GetDefinition_occurrence</a>(), <a class="code" href="../../da/df2/namespacedatabase.html#af93a39435af4e48debe6d634403174f6ad6b6d9cc5e0111e64fcc8a14032b7d01" title="descending order.">database::DESCENDING</a>);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440         <a class="code" href="../../df/dba/classdatabase_1_1SelectResultContainer.html" title="container for results of SELECT statements.">database::SelectResultContainer&lt;database::dictTableBase&gt;</a> results;
<a name="l00441"></a>00441         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ac81a7a18a1b45a2a5809a923cdc91395" title="execute select statement.">Select</a>(selectKeyWord,results);
<a name="l00442"></a>00442         <span class="keywordflow">if</span>(results.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1530b8ead15a2f1b821f4ef62c248c77" title="gets current container size.">Size</a>() == 0) {
<a name="l00443"></a>00443                 <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         <span class="comment">//fetch all information for keywords</span>
<a name="l00446"></a>00446         results.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a384f051671e8058d5b9ed38e21dca16c" title="resets iterator.">ResetIter</a>();
<a name="l00447"></a>00447         <span class="keywordflow">for</span>(;!results.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a7c7e995e6f634648f8e02dd139f60737" title="checks if iterator is at end.">IsIterEnd</a>(); results.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1b1ed522439feadf4836dea1ad3bc1ff" title="increment iterator.">Next</a>()) {
<a name="l00448"></a>00448 
<a name="l00449"></a>00449                 <span class="keyword">const</span> <a class="code" href="../../db/dfa/classdatabase_1_1dictTableBase.html" title="wrapper class for database table dict">database::dictTableBase</a>* pRow = results.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#ab6f7fab0c152ec5388a63ab94f52c3f6" title="gets current iterator.">GetIter</a>();
<a name="l00450"></a>00450 
<a name="l00451"></a>00451                 <span class="comment">//TODO: set relevance and weight to something with sense</span>
<a name="l00452"></a>00452                 <span class="keywordtype">double</span> relevance = 1.0, weight = 1.0;
<a name="l00453"></a>00453                 std::string keyword;
<a name="l00454"></a>00454                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> dictID, occurrence;
<a name="l00455"></a>00455                 pRow-&gt;<a class="code" href="../../db/dfa/classdatabase_1_1dictTableBase.html#af75ae17ad7d8f77cc1b79896c258fed8" title="gets value of ID.">Get_ID</a>(dictID);
<a name="l00456"></a>00456                 pRow-&gt;<a class="code" href="../../db/dfa/classdatabase_1_1dictTableBase.html#a5197e74cfd504e0d46b02c0b09f1e001" title="gets value of occurrence.">Get_occurrence</a>(occurrence);
<a name="l00457"></a>00457                 pRow-&gt;<a class="code" href="../../db/dfa/classdatabase_1_1dictTableBase.html#a6101a5af23013e64629b7c30cf228b5c" title="gets value of keyword.">Get_keyword</a>(keyword);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459                 idKeywords.insert(std::pair&lt;long long, KeywordEntry&gt;(dictID,<a class="code" href="../../d3/de1/classqueryserver_1_1KeywordEntry.html">KeywordEntry</a>(<a class="code" href="../../d3/de1/classqueryserver_1_1KeywordEntry.html#afe7fdf97974af4ba7566d61172217cc9a3ed66ea5521d09cb4fcab09789b5e9ca">KeywordEntry::UNKNOWN_KEYWORD_TYPE</a>, relevance, weight,keyword,dictID, occurrence)));
<a name="l00460"></a>00460         }
<a name="l00461"></a>00461         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 
<a name="l00464"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4713d4037612a5a16ff3b38fb22bfe50">00464</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4713d4037612a5a16ff3b38fb22bfe50">XMLQueryResponse::GetPageInfoByUrlStageID</a>(<span class="keyword">const</span> std::vector&lt;long long&gt;&amp; vecUrlStageID, std::map&lt;long long, PageInfo&gt;&amp; mapUrlStageIDPageInfo)
<a name="l00465"></a>00465 {
<a name="l00466"></a>00466         std::vector&lt;long long&gt; metaTypes;
<a name="l00467"></a>00467         <span class="comment">//metaTypes.push_back(1); //keywords</span>
<a name="l00468"></a>00468         metaTypes.push_back(2); <span class="comment">//description</span>
<a name="l00469"></a>00469         metaTypes.push_back(3); <span class="comment">//title</span>
<a name="l00470"></a>00470 
<a name="l00471"></a>00471         std::vector&lt;database::WhereConditionTableColumn*&gt; whereContainer;
<a name="l00472"></a>00472         <a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html#a118015d6b3dd5611be5056c79ca1b89a" title="creates where condition for a value of URLSTAGE_ID.">database::metainfoTableBase::GetWhereColumnsFor_URLSTAGE_ID</a>(
<a name="l00473"></a>00473                 <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a>(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a8f97bdd20995e906f92e9657958a0eb6">database::WhereCondition::InitialComp</a>()),
<a name="l00474"></a>00474                 vecUrlStageID,
<a name="l00475"></a>00475                 whereContainer );
<a name="l00476"></a>00476 
<a name="l00477"></a>00477         <a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html#a70f373e290004722eeed0bb74e7f9f32" title="creates where condition for a value of type.">database::metainfoTableBase::GetWhereColumnsFor_type</a>(
<a name="l00478"></a>00478                 <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a>(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#ab74611e18cb57252673663bb5e2ff6de">database::WhereCondition::And</a>()),
<a name="l00479"></a>00479                 metaTypes,
<a name="l00480"></a>00480                 whereContainer );
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         <a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html" title="implements generic sql select statement.">database::SelectStatement</a> selectMetaInfo(<a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html#a25fe2af5124e264c239b8eba673b984f" title="factory function for metainfo&#39;s table definition.">database::metainfoTableBase::CreateTableDefinition</a>());
<a name="l00483"></a>00483         selectMetaInfo.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#ad4576687383c4de60705747802b24280" title="selects all columns of statement&#39;s table.">SelectAllColumns</a>();
<a name="l00484"></a>00484         selectMetaInfo.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a2449145166e97f78a3a2428b06e0275c" title="gets where condition of this statement.">Where</a>().<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a958e50302a66209914132a02c57e2088" title="add multiple where conditions for multiple columns.">AddColumns</a>(whereContainer);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486         <a class="code" href="../../df/dba/classdatabase_1_1SelectResultContainer.html" title="container for results of SELECT statements.">database::SelectResultContainer&lt;database::metainfoTableBase&gt;</a> vecMetaInfoTbls;
<a name="l00487"></a>00487         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ac81a7a18a1b45a2a5809a923cdc91395" title="execute select statement.">Select</a>(selectMetaInfo,vecMetaInfoTbls);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         vecMetaInfoTbls.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a384f051671e8058d5b9ed38e21dca16c" title="resets iterator.">ResetIter</a>();
<a name="l00490"></a>00490         <span class="keywordflow">for</span>(;!vecMetaInfoTbls.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a7c7e995e6f634648f8e02dd139f60737" title="checks if iterator is at end.">IsIterEnd</a>(); vecMetaInfoTbls.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1b1ed522439feadf4836dea1ad3bc1ff" title="increment iterator.">Next</a>()) {
<a name="l00491"></a>00491 
<a name="l00492"></a>00492                 <a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html" title="wrapper class for database table metainfo">database::metainfoTableBase</a>* pRow = vecMetaInfoTbls.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#ab6f7fab0c152ec5388a63ab94f52c3f6" title="gets current iterator.">GetIter</a>();
<a name="l00493"></a>00493                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> type = -1, urlStageID = -1;
<a name="l00494"></a>00494                 pRow-&gt;<a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html#ae8cdc1c7d3c7858c988b7fb38c92410b" title="gets value of type.">Get_type</a>(type);
<a name="l00495"></a>00495                 pRow-&gt;<a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html#a7eed7bc308f39ce84e9c43aa64248c12" title="gets value of URLSTAGE_ID.">Get_URLSTAGE_ID</a>(urlStageID);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497                 <span class="keywordflow">switch</span>(type)
<a name="l00498"></a>00498                 {
<a name="l00499"></a>00499                 <span class="keywordflow">case</span> 2:
<a name="l00500"></a>00500                         pRow-&gt;<a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html#accc13998a3bbafe9097fc4b86b7632e2" title="gets value of value.">Get_value</a>(mapUrlStageIDPageInfo[urlStageID].description);
<a name="l00501"></a>00501                         <span class="keywordflow">break</span>;
<a name="l00502"></a>00502                 <span class="keywordflow">case</span> 3:
<a name="l00503"></a>00503                         pRow-&gt;<a class="code" href="../../d1/dd2/classdatabase_1_1metainfoTableBase.html#accc13998a3bbafe9097fc4b86b7632e2" title="gets value of value.">Get_value</a>(mapUrlStageIDPageInfo[urlStageID].title);
<a name="l00504"></a>00504                         <span class="keywordflow">break</span>;
<a name="l00505"></a>00505                 <span class="keywordflow">default</span>:
<a name="l00506"></a>00506                         <span class="keywordflow">continue</span>;
<a name="l00507"></a>00507                 }
<a name="l00508"></a>00508         }
<a name="l00509"></a>00509         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00510"></a>00510 }
<a name="l00511"></a>00511 
<a name="l00512"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#af870c281773c4ab9fa340eb0d60c26a2">00512</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#af870c281773c4ab9fa340eb0d60c26a2">XMLQueryResponse::GetPageUrlStageInfo</a>(<span class="keyword">const</span> std::map&lt;<span class="keywordtype">long</span> <span class="keywordtype">long</span>, std::vector&lt;KeywordEntry&gt; &gt;&amp; idUrlStage, std::map&lt;long long, long long&gt;&amp; mapUrlStageIDUrlID, std::map&lt;long long, UrlStageProperties&gt;&amp; mapUrlStages)
<a name="l00513"></a>00513 {
<a name="l00514"></a>00514         std::vector&lt;long long&gt; vecUrlStageID;
<a name="l00515"></a>00515         <a class="code" href="../../d6/d19/classtools_1_1ContainerTools.html#aa3319436a0b504fbc8c830d6b82b9f07" title="converts first entry(key) of std::map to std::vector">tools::ContainerTools::Map1ToVector</a>(idUrlStage,vecUrlStageID);
<a name="l00516"></a>00516         <span class="keywordflow">if</span>(vecUrlStageID.size()==0)
<a name="l00517"></a>00517                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         std::vector&lt;database::WhereConditionTableColumn*&gt; whereContainer;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521         <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a> paramUrlStagesID(<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a8f97bdd20995e906f92e9657958a0eb6">database::WhereCondition::InitialComp</a>());
<a name="l00522"></a>00522         paramUrlStagesID.<a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html#af9c9841b96277f41a315f8f5fe8fefb3" title="alias table name.">tableNameAlias</a> = <span class="stringliteral">&quot;theStages&quot;</span>;
<a name="l00523"></a>00523         <a class="code" href="../../d9/d80/classdatabase_1_1urlstagesTableBase.html#ad3c2da3958db44b86fc6a065350a95d7" title="creates where condition for a value of ID.">database::urlstagesTableBase::GetWhereColumnsFor_ID</a>(
<a name="l00524"></a>00524                 paramUrlStagesID,
<a name="l00525"></a>00525                 vecUrlStageID,
<a name="l00526"></a>00526                 whereContainer );
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         <a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html" title="implements generic sql select statement.">database::SelectStatement</a> selectUrlStages(<a class="code" href="../../d9/d80/classdatabase_1_1urlstagesTableBase.html#ac77a4f841ada9be64e82cf82162a465b" title="factory function for urlstages&#39;s table definition.">database::urlstagesTableBase::CreateTableDefinition</a>(), <span class="stringliteral">&quot;theStages&quot;</span>);
<a name="l00529"></a>00529         selectUrlStages.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#ad4576687383c4de60705747802b24280" title="selects all columns of statement&#39;s table.">SelectAllColumns</a>();
<a name="l00530"></a>00530         selectUrlStages.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a182e67cdbf2ab279ced5084f2e6bc82a" title="adds single column.">SelectAddColumn</a>(<a class="code" href="../../dc/d71/classdatabase_1_1urlsTableBase.html#af1f966c03507cad1e11bd5e08bb90012" title="create a column definition for column SECONDLEVELDOMAIN_ID.">database::urlsTableBase::GetDefinition_SECONDLEVELDOMAIN_ID</a>(),<span class="stringliteral">&quot;theUrls&quot;</span>,<span class="stringliteral">&quot;SECONDLEVELDOMAIN_ID&quot;</span>);
<a name="l00531"></a>00531         selectUrlStages.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a2449145166e97f78a3a2428b06e0275c" title="gets where condition of this statement.">Where</a>().<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a958e50302a66209914132a02c57e2088" title="add multiple where conditions for multiple columns.">AddColumns</a>(whereContainer);
<a name="l00532"></a>00532         <a class="code" href="../../d9/d80/classdatabase_1_1urlstagesTableBase.html#ac62f547f385d10ce3337c4fba3ff3cf4">database::urlstagesTableBase::AddInnerJoinRightSideOn_URL_ID</a>(<span class="stringliteral">&quot;theStages&quot;</span>,<span class="stringliteral">&quot;URL_ID&quot;</span>,<span class="stringliteral">&quot;theUrls&quot;</span>,<span class="stringliteral">&quot;ID&quot;</span>,selectUrlStages);
<a name="l00533"></a>00533 
<a name="l00534"></a>00534         <a class="code" href="../../df/dba/classdatabase_1_1SelectResultContainer.html" title="container for results of SELECT statements.">database::SelectResultContainer&lt;database::TableBase&gt;</a> vecUrlStages;
<a name="l00535"></a>00535         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ac81a7a18a1b45a2a5809a923cdc91395" title="execute select statement.">Select</a>(selectUrlStages,vecUrlStages);
<a name="l00536"></a>00536         <span class="keywordflow">if</span>(vecUrlStages.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1530b8ead15a2f1b821f4ef62c248c77" title="gets current container size.">Size</a>() == 0) {
<a name="l00537"></a>00537                 <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539         vecUrlStages.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a384f051671e8058d5b9ed38e21dca16c" title="resets iterator.">ResetIter</a>();
<a name="l00540"></a>00540         <span class="keywordflow">for</span>(;!vecUrlStages.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a7c7e995e6f634648f8e02dd139f60737" title="checks if iterator is at end.">IsIterEnd</a>();vecUrlStages.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1b1ed522439feadf4836dea1ad3bc1ff" title="increment iterator.">Next</a>()) {
<a name="l00541"></a>00541 
<a name="l00542"></a>00542                 <a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html" title="implements generic table row class.">database::TableBase</a>* pRow = vecUrlStages.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#ab6f7fab0c152ec5388a63ab94f52c3f6" title="gets current iterator.">GetIter</a>();
<a name="l00543"></a>00543 
<a name="l00544"></a>00544                 <span class="comment">//TODO: do more with urlstage data</span>
<a name="l00545"></a>00545                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlStageID = -1, urlID = -1, secondLevelDomainID = -1;
<a name="l00546"></a>00546                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> contentSize = -1;
<a name="l00547"></a>00547                 <span class="keyword">struct </span>tm lastVisited,lastChanged;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;ID&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(urlStageID);
<a name="l00550"></a>00550                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;URL_ID&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(urlID);
<a name="l00551"></a>00551                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;found_date&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(lastVisited);
<a name="l00552"></a>00552                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;last_change&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(lastChanged);
<a name="l00553"></a>00553                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;content_length&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(contentSize);
<a name="l00554"></a>00554                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;SECONDLEVELDOMAIN_ID&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(secondLevelDomainID);
<a name="l00555"></a>00555 
<a name="l00556"></a>00556                 mapUrlStages.insert(std::pair&lt;long long,UrlStageProperties&gt;(urlStageID,<a class="code" href="../../df/de7/classqueryserver_1_1UrlStageProperties.html">UrlStageProperties</a>(urlStageID,urlID, secondLevelDomainID,lastVisited,lastChanged,contentSize)));
<a name="l00557"></a>00557                 mapUrlStageIDUrlID[urlStageID] = urlID;
<a name="l00558"></a>00558         }
<a name="l00559"></a>00559         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00560"></a>00560 }
<a name="l00561"></a>00561 
<a name="l00562"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a877f6d3d72ac398dbe569ee546ed2fec">00562</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a877f6d3d72ac398dbe569ee546ed2fec">XMLQueryResponse::GetPageRelevanceByBacklinks</a>(<span class="keyword">const</span> std::map&lt;long long, long long&gt;&amp; mapUrlStageIDUrlID, std::map&lt;long long, BackLinkEntry&gt;&amp; urlStageIDBackLinks )
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564         std::map&lt;long long, long long&gt;::const_iterator iterUrlStagesUrl = mapUrlStageIDUrlID.begin();
<a name="l00565"></a>00565         <span class="keywordflow">for</span>(;iterUrlStagesUrl != mapUrlStageIDUrlID.end(); ++iterUrlStagesUrl) {
<a name="l00566"></a>00566                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlStageID = iterUrlStagesUrl-&gt;first;
<a name="l00567"></a>00567                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlID      = iterUrlStagesUrl-&gt;second;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569                 std::map&lt;long long,htmlparser::DatabaseUrl&gt; mapIDUrls;
<a name="l00570"></a>00570                 <a class="code" href="../../d6/d05/classhtmlparser_1_1DatabaseUrl.html#aa8ac59b05330947c904c6cae8abfa88c" title="gets backlinks for an url.">htmlparser::DatabaseUrl::GetBackLinks</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>(), urlID, mapIDUrls);
<a name="l00571"></a>00571 
<a name="l00572"></a>00572                 std::vector&lt;htmlparser::DatabaseUrl&gt; vecURLs;
<a name="l00573"></a>00573                 <a class="code" href="../../d6/d19/classtools_1_1ContainerTools.html#a10b5ce6dedb0a1774a4cce5a3a6f6b4b" title="converts second entry(value) of std::map to std::vector">tools::ContainerTools::Map2ToVector</a>(mapIDUrls,vecURLs);
<a name="l00574"></a>00574                 urlStageIDBackLinks.insert(std::pair&lt;long long, BackLinkEntry&gt;(urlStageID,<a class="code" href="../../d2/d09/classqueryserver_1_1BackLinkEntry.html">BackLinkEntry</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a2b8063240c48ead5cf933ae6d9a6fc1f">BackLinkRelevance</a>(),1.0,urlStageID,vecURLs)));
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00577"></a>00577 }
<a name="l00578"></a>00578 
<a name="l00579"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a2bca896347f8bf19e235defb0ca01ffe">00579</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a2bca896347f8bf19e235defb0ca01ffe">XMLQueryResponse::SortResults</a>(<span class="keyword">const</span> std::map&lt;long long, UrlStageEntry &gt;&amp; idUrlStages, <span class="keyword">const</span> std::map&lt;long long, BackLinkEntry&gt;&amp; urlStageIDBackLinks, std::vector&lt;long long&gt;&amp; sortedUrlStageIDs, std::map&lt;long long, Relevance&gt;&amp; urlStageRelevance )
<a name="l00580"></a>00580 {
<a name="l00581"></a>00581         std::map&lt;long long, UrlStageEntry &gt;::const_iterator iterUrlStageEntries = idUrlStages.begin();
<a name="l00582"></a>00582         <span class="keywordflow">for</span>(;iterUrlStageEntries != idUrlStages.end(); ++iterUrlStageEntries) {
<a name="l00583"></a>00583 
<a name="l00584"></a>00584                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlStageID = iterUrlStageEntries-&gt;first;
<a name="l00585"></a>00585                 <span class="keyword">const</span> <a class="code" href="../../d2/d92/classqueryserver_1_1UrlStageEntry.html">UrlStageEntry</a>&amp; urlStageEntry = iterUrlStageEntries-&gt;second;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587                 std::pair&lt;long long, Relevance&gt; insertPair(urlStageID,urlStageEntry.<a class="code" href="../../d2/d92/classqueryserver_1_1UrlStageEntry.html#ac89a66646da8019d16ffa97a4d2f879d">GetTotalRelevance</a>());
<a name="l00588"></a>00588                 urlStageRelevance.insert(insertPair);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590                 <span class="keywordflow">if</span>(urlStageIDBackLinks.count(urlStageID) &gt; 0 &amp;&amp; urlStageIDBackLinks.at(urlStageID).UrlStageID() != -1) {
<a name="l00591"></a>00591 
<a name="l00592"></a>00592                         <span class="keyword">const</span> <a class="code" href="../../d2/d09/classqueryserver_1_1BackLinkEntry.html">BackLinkEntry</a>&amp; backlinks = urlStageIDBackLinks.at(urlStageID);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594                         <span class="comment">//TODO: maybe give per link relevance (i.e. based on the links relevancy/quality itself, PageRank etc.)</span>
<a name="l00595"></a>00595                         <span class="comment">/*</span>
<a name="l00596"></a>00596 <span class="comment">                        const std::vector&lt;URL&gt;&amp; backlinksUrls = backlinks.BackLinks();</span>
<a name="l00597"></a>00597 <span class="comment">                        std::vector&lt;URL&gt;::const_iterator iterBackLinks = backlinksUrls.begin();</span>
<a name="l00598"></a>00598 <span class="comment">                        for(;iterBackLinks != backlinksUrls.end();++iterBackLinks) {</span>
<a name="l00599"></a>00599 <span class="comment">                        }</span>
<a name="l00600"></a>00600 <span class="comment">                        */</span>
<a name="l00601"></a>00601 
<a name="l00602"></a>00602                         <span class="keywordflow">if</span>(urlStageRelevance.count(urlStageID) == 0) {
<a name="l00603"></a>00603                                 urlStageRelevance.insert(std::pair&lt;long long, Relevance&gt;(urlStageID,(<span class="keyword">const</span> <a class="code" href="../../d7/d71/classqueryserver_1_1Relevance.html">Relevance</a>&amp;)backlinks));
<a name="l00604"></a>00604                         }
<a name="l00605"></a>00605                         <span class="keywordflow">else</span>{
<a name="l00606"></a>00606                                 <a class="code" href="../../d7/d71/classqueryserver_1_1Relevance.html">Relevance</a> totalRelevance(urlStageRelevance.at(urlStageID) + (<span class="keyword">const</span> <a class="code" href="../../d7/d71/classqueryserver_1_1Relevance.html">Relevance</a>&amp;)backlinks);
<a name="l00607"></a>00607                                 std::pair&lt;long long, Relevance&gt; insertPair(urlStageID,totalRelevance);
<a name="l00608"></a>00608                                 std::pair&lt; std::map&lt;long long,Relevance&gt;::iterator, <span class="keywordtype">bool</span> &gt; ret = urlStageRelevance.insert(insertPair);
<a name="l00609"></a>00609                                 <span class="keywordflow">if</span>(!ret.second) { ret.first-&gt;second = insertPair.second; }
<a name="l00610"></a>00610                         }
<a name="l00611"></a>00611                 }
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         std::map&lt;double, std::vector&lt;long long&gt; &gt; mapRelevanceUrlStageID;
<a name="l00615"></a>00615         std::map&lt;long long, Relevance&gt;::const_iterator iterUrlStageIDRelevance = urlStageRelevance.begin();
<a name="l00616"></a>00616         <span class="keywordflow">for</span>(;iterUrlStageIDRelevance != urlStageRelevance.end();++iterUrlStageIDRelevance) {
<a name="l00617"></a>00617                 mapRelevanceUrlStageID[iterUrlStageIDRelevance-&gt;second.GetWeightedRelevance()].push_back(iterUrlStageIDRelevance-&gt;first); }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619         std::map&lt;double, std::vector&lt;long long&gt; &gt;::const_iterator sortUrlStageIDs = mapRelevanceUrlStageID.begin();
<a name="l00620"></a>00620         <span class="keywordflow">for</span>(;sortUrlStageIDs != mapRelevanceUrlStageID.end();++sortUrlStageIDs) {
<a name="l00621"></a>00621                 <span class="keyword">const</span> std::vector&lt;long long&gt;&amp; vecUrlStages = sortUrlStageIDs-&gt;second;
<a name="l00622"></a>00622                 std::vector&lt;long long&gt;::const_iterator iterUrlStages = vecUrlStages.begin();
<a name="l00623"></a>00623                 <span class="keywordflow">for</span>(;iterUrlStages != vecUrlStages.end();++iterUrlStages) {
<a name="l00624"></a>00624                         sortedUrlStageIDs.insert(sortedUrlStageIDs.begin(),*iterUrlStages);     }
<a name="l00625"></a>00625         }
<a name="l00626"></a>00626         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00627"></a>00627 }
<a name="l00628"></a>00628 
<a name="l00629"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a46ecfaa120fdec0822def19202ced0be">00629</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a46ecfaa120fdec0822def19202ced0be">XMLQueryResponse::OutputResults</a>(
<a name="l00630"></a>00630                 <span class="keyword">const</span> std::vector&lt;long long&gt;&amp; sortedUrlStageIDs,
<a name="l00631"></a>00631                 <span class="keyword">const</span> std::map&lt;long long, long long&gt;&amp; mapUrlStageIDUrlID,
<a name="l00632"></a>00632                 <span class="keyword">const</span> std::map&lt;long long, PageInfo&gt;&amp; mapUrlStagePageInfo,
<a name="l00633"></a>00633                 <span class="keyword">const</span> std::map&lt;long long, htmlparser::DatabaseUrl&gt;&amp; mapUrls)
<a name="l00634"></a>00634 {
<a name="l00635"></a>00635         std::stringstream xmlContent;
<a name="l00636"></a>00636         xmlContent &lt;&lt;
<a name="l00637"></a>00637                 <span class="stringliteral">&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span>
<a name="l00638"></a>00638                 <span class="stringliteral">&quot;&lt;response&gt;&quot;</span>
<a name="l00639"></a>00639                 <span class="stringliteral">&quot;&lt;queryId&gt;&quot;</span> &lt;&lt; <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a0085f0e0633866ec7e7cc81c00fa1f7c">QueryID</a>() &lt;&lt; <span class="stringliteral">&quot;&lt;/queryId&gt;&quot;</span>
<a name="l00640"></a>00640                 <span class="stringliteral">&quot;&lt;pageNo&gt;&quot;</span> &lt;&lt; <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a2cd970369c08d039038c5d0613de0b92">PageNumber</a>() &lt;&lt; <span class="stringliteral">&quot;&lt;/pageNo&gt;&quot;</span>
<a name="l00641"></a>00641                 <span class="stringliteral">&quot;&lt;totalResults&gt;&quot;</span> &lt;&lt; <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#adc683ece48a6f24b23b8df70b7f7c3c9">countResults</a> &lt;&lt; <span class="stringliteral">&quot;&lt;/totalResults&gt;&quot;</span>;
<a name="l00642"></a>00642         std::vector&lt;long long&gt;::const_iterator iterSortedUrlStage = sortedUrlStageIDs.begin();
<a name="l00643"></a>00643         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1;iterSortedUrlStage != sortedUrlStageIDs.end();i++,++iterSortedUrlStage) {
<a name="l00644"></a>00644                 <span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlStageID = *iterSortedUrlStage;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646                 <span class="keywordflow">if</span>(     mapUrlStageIDUrlID.count(urlStageID)  == 0 ||
<a name="l00647"></a>00647                         mapUrlStagePageInfo.count(urlStageID) == 0 ) {
<a name="l00648"></a>00648                                 std::stringstream ssStream;
<a name="l00649"></a>00649                                 ssStream &lt;&lt; <span class="stringliteral">&quot;could not find information for urlstage id: &quot;</span> &lt;&lt; urlStageID;
<a name="l00650"></a>00650                                 <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba629f976f682f75c5279ad61bcf7f306e" title="errors">log::Logging::LOGLEVEL_ERROR</a>,ssStream.str());
<a name="l00651"></a>00651                                 <span class="keywordflow">continue</span>; }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653                 <span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlID      = mapUrlStageIDUrlID.at(urlStageID);
<a name="l00654"></a>00654                 <span class="keyword">const</span> <a class="code" href="../../d0/d52/classqueryserver_1_1PageInfo.html">PageInfo</a>&amp; pageInfo                   = mapUrlStagePageInfo.at(urlStageID);
<a name="l00655"></a>00655                 <span class="keywordflow">if</span>(     mapUrls.count(urlID) == 0 ){
<a name="l00656"></a>00656                         std::stringstream ssStream;
<a name="l00657"></a>00657                         ssStream &lt;&lt; <span class="stringliteral">&quot;could not find information for url id: &quot;</span> &lt;&lt; urlID;
<a name="l00658"></a>00658                         <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba629f976f682f75c5279ad61bcf7f306e" title="errors">log::Logging::LOGLEVEL_ERROR</a>,ssStream.str());
<a name="l00659"></a>00659                         <span class="keywordflow">continue</span>; }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661                 <span class="keyword">const</span> <a class="code" href="../../d6/d05/classhtmlparser_1_1DatabaseUrl.html" title="class for database related functionality of URLs.">htmlparser::DatabaseUrl</a>&amp; url = mapUrls.at(urlID);
<a name="l00662"></a>00662 
<a name="l00663"></a>00663                 <span class="comment">//const UrlStageEntry&amp; urlStageEntry         = mapUrlStageEntry.at(urlStageID);</span>
<a name="l00664"></a>00664                 <span class="comment">//const UrlStageProperties&amp; urlStageProperty = urlStageEntry.UrlStageProperty();</span>
<a name="l00665"></a>00665 
<a name="l00666"></a>00666                 std::string lastVisitedString, lastChangedString;
<a name="l00667"></a>00667 <span class="comment">/*</span>
<a name="l00668"></a>00668 <span class="comment">                const struct tm&amp; lastVisited = urlStageProperty.LastVisited();</span>
<a name="l00669"></a>00669 <span class="comment">                const struct tm&amp; lastChanged = urlStageProperty.LastChanged();</span>
<a name="l00670"></a>00670 <span class="comment">                if( lastVisited.tm_year != 0)</span>
<a name="l00671"></a>00671 <span class="comment">                        database::DatabaseHelper::TmToDateTime(lastVisited,lastVisitedString);</span>
<a name="l00672"></a>00672 <span class="comment">                if( lastChanged.tm_year != 0)</span>
<a name="l00673"></a>00673 <span class="comment">                        database::DatabaseHelper::TmToDateTime(lastChanged,lastChangedString);</span>
<a name="l00674"></a>00674 <span class="comment">*/</span>
<a name="l00675"></a>00675                 std::string encodedURL = url.<a class="code" href="../../d8/dae/classnetwork_1_1HttpUrl.html#ad0568018a862bed21c575babed630406">GetFullUrl</a>();
<a name="l00676"></a>00676                 <a class="code" href="../../d5/dc6/classnetwork_1_1HttpUrlParser.html#a1abaaa2031d73b4f73e2bca96be7df71" title="url encode string">network::HttpUrlParser::EncodeUrl</a>(encodedURL);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678                 std::string encodedTitle = pageInfo.<a class="code" href="../../d0/d52/classqueryserver_1_1PageInfo.html#acff6b0521e6a31e88a3dbfce0050b741">Title</a>();
<a name="l00679"></a>00679                 <a class="code" href="../../d5/dc6/classnetwork_1_1HttpUrlParser.html#a1abaaa2031d73b4f73e2bca96be7df71" title="url encode string">network::HttpUrlParser::EncodeUrl</a>(encodedTitle);
<a name="l00680"></a>00680 
<a name="l00681"></a>00681                 std::string encodedDescription = pageInfo.<a class="code" href="../../d0/d52/classqueryserver_1_1PageInfo.html#ad0dfe259a4fa8e8d31839d2b442114bd">Description</a>();
<a name="l00682"></a>00682                 <a class="code" href="../../d5/dc6/classnetwork_1_1HttpUrlParser.html#a1abaaa2031d73b4f73e2bca96be7df71" title="url encode string">network::HttpUrlParser::EncodeUrl</a>(encodedDescription);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684                 std::vector&lt;std::string&gt; encodedKeywordEntries;
<a name="l00685"></a>00685                 <span class="comment">/*</span>
<a name="l00686"></a>00686 <span class="comment">                const std::vector&lt;KeywordEntry&gt;&amp; keywords = urlStageEntry.Keywords();</span>
<a name="l00687"></a>00687 <span class="comment">                std::vector&lt;KeywordEntry&gt;::const_iterator iterKeywords = keywords.begin();</span>
<a name="l00688"></a>00688 <span class="comment">                for(;iterKeywords != keywords.end();++iterKeywords) {</span>
<a name="l00689"></a>00689 <span class="comment">                        std::stringstream ssKeywordPart;</span>
<a name="l00690"></a>00690 <span class="comment">                        std::string encodedKeyword = iterKeywords-&gt;GetKeyword();</span>
<a name="l00691"></a>00691 <span class="comment">                        UrlParser::EncodeUrl(encodedKeyword);</span>
<a name="l00692"></a>00692 <span class="comment">                        ssKeywordPart</span>
<a name="l00693"></a>00693 <span class="comment">                                &lt;&lt; &quot;&lt;keyword relevancy=\&quot;&quot; &lt;&lt; iterKeywords-&gt;GetWeightedRelevance() &lt;&lt; &quot;\&quot; type=\&quot;&quot; &lt;&lt; KeywordEntryTypeConverter::ToString(iterKeywords-&gt;GetType()) &lt;&lt; &quot;\&quot;&gt;&quot; &lt;&lt; encodedKeyword &lt;&lt; &quot;&lt;/keyword&gt;&quot;;</span>
<a name="l00694"></a>00694 <span class="comment">                        encodedKeywordEntries.push_back(ssKeywordPart.str());</span>
<a name="l00695"></a>00695 <span class="comment">                }</span>
<a name="l00696"></a>00696 <span class="comment">                */</span>
<a name="l00697"></a>00697 
<a name="l00698"></a>00698                 std::string dumpEncoded;
<a name="l00699"></a>00699                 <a class="code" href="../../de/d7e/classtools_1_1StringTools.html#a8c6681c82d5d5741cb44f30dd1700a0e" title="converts generic vector to a string.">tools::StringTools::VectorToString</a>(encodedKeywordEntries,dumpEncoded);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701                 xmlContent &lt;&lt;
<a name="l00702"></a>00702                 <span class="stringliteral">&quot;&lt;result id=\&quot;&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;\&quot;&gt;&quot;</span>
<a name="l00703"></a>00703                 <span class="stringliteral">&quot;&lt;url id=\&quot;&quot;</span> &lt;&lt; urlID &lt;&lt; <span class="stringliteral">&quot;\&quot;&gt;&quot;</span> &lt;&lt; encodedURL &lt;&lt; <span class="stringliteral">&quot;&lt;/url&gt;&quot;</span>
<a name="l00704"></a>00704                 <span class="stringliteral">&quot;&lt;title&gt;&quot;</span> &lt;&lt; encodedTitle &lt;&lt; <span class="stringliteral">&quot;&lt;/title&gt;&quot;</span>
<a name="l00705"></a>00705                 <span class="stringliteral">&quot;&lt;description&gt;&quot;</span> &lt;&lt; encodedDescription &lt;&lt; <span class="stringliteral">&quot;&lt;/description&gt;&quot;</span>
<a name="l00706"></a>00706                 <span class="stringliteral">&quot;&lt;lastVisited&gt;&quot;</span> &lt;&lt; lastVisitedString &lt;&lt; <span class="stringliteral">&quot;&lt;/lastVisited&gt;&quot;</span>
<a name="l00707"></a>00707                 <span class="stringliteral">&quot;&lt;lastChanged&gt;&quot;</span> &lt;&lt; lastChangedString &lt;&lt; <span class="stringliteral">&quot;&lt;/lastChanged&gt;&quot;</span>
<a name="l00708"></a>00708                 <span class="stringliteral">&quot;&lt;keywords&gt;&quot;</span> &lt;&lt; dumpEncoded &lt;&lt; <span class="stringliteral">&quot;&lt;/keywords&gt;&quot;</span>
<a name="l00709"></a>00709 <span class="comment">//              &quot;\t&lt;relevancyWeighted&gt;&quot; &lt;&lt; urlStageEntry.GetTotalRelevance().GetWeightedRelevance() &lt;&lt; &quot;&lt;/relevancyWeighted&gt;\n&quot;</span>
<a name="l00710"></a>00710 <span class="comment">//              &quot;\t&lt;relevancy&gt;&quot; &lt;&lt; urlStageEntry.GetTotalRelevance().GetRelevance() &lt;&lt; &quot;&lt;/relevancy&gt;\n&quot;</span>
<a name="l00711"></a>00711 <span class="comment">//              &quot;\t&lt;weight&gt;&quot; &lt;&lt; urlStageEntry.GetTotalRelevance().GetWeight() &lt;&lt; &quot;&lt;/weight&gt;\n&quot;</span>
<a name="l00712"></a>00712                 <span class="stringliteral">&quot;&lt;/result&gt;&quot;</span>;
<a name="l00713"></a>00713         }
<a name="l00714"></a>00714         xmlContent &lt;&lt; <span class="stringliteral">&quot;&lt;/response&gt;\n&quot;</span>;
<a name="l00715"></a>00715         <a class="code" href="../../d3/d3b/classfastcgiserver_1_1FastCGIResponse.html#a11e7ebb361dc51526c62f7eca233e862" title="content of response.">content</a> = xmlContent.str();
<a name="l00716"></a>00716         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00717"></a>00717 }
<a name="l00718"></a>00718 
<a name="l00719"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4fb110f540766f229fd689f342650f87">00719</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a4fb110f540766f229fd689f342650f87">XMLQueryResponse::GetPagesByUrlPath</a>(<span class="keyword">const</span> std::map&lt;long long, KeywordEntry&gt;&amp; idKeywords, std::map&lt;<span class="keywordtype">long</span> <span class="keywordtype">long</span>, std::vector&lt;KeywordEntry&gt; &gt;&amp; idUrlStage )
<a name="l00720"></a>00720 {
<a name="l00721"></a>00721         std::vector&lt;database::WhereConditionTableColumn*&gt; whereContainer;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723         <a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html" title="create parameters for where columns.">database::WhereConditionTableColumnCreateParam</a> whereDictParam(
<a name="l00724"></a>00724                 <a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a6d1c691be79c14947c2a804a4d099423">database::WhereCondition::Equals</a>(),
<a name="l00725"></a>00725                 <a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a8f97bdd20995e906f92e9657958a0eb6">database::WhereCondition::InitialComp</a>());
<a name="l00726"></a>00726         whereDictParam.<a class="code" href="../../d5/dd0/classdatabase_1_1WhereConditionTableColumnCreateParam.html#af9c9841b96277f41a315f8f5fe8fefb3" title="alias table name.">tableNameAlias</a> = <span class="stringliteral">&quot;doc&quot;</span>;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728         std::vector&lt;long long&gt; idKeywordVector;
<a name="l00729"></a>00729         <a class="code" href="../../d6/d19/classtools_1_1ContainerTools.html#aa3319436a0b504fbc8c830d6b82b9f07" title="converts first entry(key) of std::map to std::vector">tools::ContainerTools::Map1ToVector</a>(idKeywords,idKeywordVector);
<a name="l00730"></a>00730         <a class="code" href="../../d0/ddf/classdatabase_1_1docurlTableBase.html#a7beb67dc499ad20487700be11ccf5911" title="creates where condition for a value of DICT_ID.">database::docurlTableBase::GetWhereColumnsFor_DICT_ID</a>(
<a name="l00731"></a>00731                 whereDictParam,
<a name="l00732"></a>00732                 idKeywordVector,
<a name="l00733"></a>00733                 whereContainer );
<a name="l00734"></a>00734 
<a name="l00735"></a>00735         <a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html" title="implements generic sql select statement.">database::SelectStatement</a> dockeyInfo(<a class="code" href="../../d0/ddf/classdatabase_1_1docurlTableBase.html#a98a4c746542ac42af59d4e259035b590" title="factory function for docurl&#39;s table definition.">database::docurlTableBase::CreateTableDefinition</a>(),<span class="stringliteral">&quot;doc&quot;</span>);
<a name="l00736"></a>00736         dockeyInfo.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#ad4576687383c4de60705747802b24280" title="selects all columns of statement&#39;s table.">SelectAllColumns</a>();
<a name="l00737"></a>00737         dockeyInfo.<a class="code" href="../../d8/d97/classdatabase_1_1SelectStatement.html#a2449145166e97f78a3a2428b06e0275c" title="gets where condition of this statement.">Where</a>().<a class="code" href="../../db/dde/classdatabase_1_1WhereCondition.html#a958e50302a66209914132a02c57e2088" title="add multiple where conditions for multiple columns.">AddColumns</a>(whereContainer);
<a name="l00738"></a>00738         <a class="code" href="../../d0/ddf/classdatabase_1_1docurlTableBase.html#a91de4df74e4b4378ff57f5e26dd7b29c">database::docurlTableBase::AddInnerJoinRightSideOn_URL_ID</a>(<span class="stringliteral">&quot;doc&quot;</span>, <span class="stringliteral">&quot;URL_ID&quot;</span>,<span class="stringliteral">&quot;theUrl&quot;</span>,<span class="stringliteral">&quot;ID&quot;</span>,dockeyInfo);
<a name="l00739"></a>00739         <a class="code" href="../../d1/da6/classdatabase_1_1latesturlstagesTableBase.html#a46c131382bdcafd3d1cfc7dab3f12444">database::latesturlstagesTableBase::AddInnerJoinLeftSideOn_URL_ID</a>(<span class="stringliteral">&quot;latest&quot;</span>, <span class="stringliteral">&quot;URL_ID&quot;</span>, <span class="stringliteral">&quot;theUrl&quot;</span>,<span class="stringliteral">&quot;ID&quot;</span>, dockeyInfo);
<a name="l00740"></a>00740 
<a name="l00741"></a>00741         <a class="code" href="../../df/dba/classdatabase_1_1SelectResultContainer.html" title="container for results of SELECT statements.">database::SelectResultContainer&lt;database::TableBase&gt;</a> vecDocRows;
<a name="l00742"></a>00742         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ac81a7a18a1b45a2a5809a923cdc91395" title="execute select statement.">Select</a>(dockeyInfo,vecDocRows);
<a name="l00743"></a>00743         <span class="keywordflow">if</span>( vecDocRows.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1530b8ead15a2f1b821f4ef62c248c77" title="gets current container size.">Size</a>() == 0 ) {
<a name="l00744"></a>00744                 <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         vecDocRows.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a384f051671e8058d5b9ed38e21dca16c" title="resets iterator.">ResetIter</a>();
<a name="l00747"></a>00747         <span class="keywordflow">for</span>(;!vecDocRows.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a7c7e995e6f634648f8e02dd139f60737" title="checks if iterator is at end.">IsIterEnd</a>(); vecDocRows.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#a1b1ed522439feadf4836dea1ad3bc1ff" title="increment iterator.">Next</a>()) {
<a name="l00748"></a>00748 
<a name="l00749"></a>00749                 <a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html" title="implements generic table row class.">database::TableBase</a>* pRow = vecDocRows.<a class="code" href="../../de/d22/classtools_1_1PointerContainer.html#ab6f7fab0c152ec5388a63ab94f52c3f6" title="gets current iterator.">GetIter</a>();
<a name="l00750"></a>00750 
<a name="l00751"></a>00751                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> dictID = -1, urlStageID = -1;
<a name="l00752"></a>00752                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;DICT_ID&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(dictID);
<a name="l00753"></a>00753                 pRow-&gt;<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a4ef61c8a9cfcd414a6aba053d36a1e03" title="finds column by it&#39;s name.">GetConstColumnByName</a>(<span class="stringliteral">&quot;URLSTAGE_ID&quot;</span>)-&gt;<a class="code" href="../../db/d1f/classdatabase_1_1TableColumn.html#a28608d02b0b932f5f39fbc301595661b" title="gets the value of the column.">Get</a>(urlStageID);
<a name="l00754"></a>00754 
<a name="l00755"></a>00755                 std::map&lt;long long, KeywordEntry&gt;::const_iterator posKeyword = idKeywords.find(dictID);
<a name="l00756"></a>00756                 <span class="keywordflow">if</span>(posKeyword == idKeywords.end()) {
<a name="l00757"></a>00757                         <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba629f976f682f75c5279ad61bcf7f306e" title="errors">log::Logging::LOGLEVEL_ERROR</a>,<span class="stringliteral">&quot;could not find keyword matching for content information&quot;</span>);
<a name="l00758"></a>00758                         <span class="keywordflow">continue</span>; }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760                 <span class="comment">//TODO: maybe set weight</span>
<a name="l00761"></a>00761                 <span class="keywordtype">double</span> weight = 1.0;
<a name="l00762"></a>00762                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> occurrence = 1;
<a name="l00763"></a>00763                 idUrlStage[urlStageID].push_back(
<a name="l00764"></a>00764                         <a class="code" href="../../d3/de1/classqueryserver_1_1KeywordEntry.html">KeywordEntry</a>(<a class="code" href="../../d3/de1/classqueryserver_1_1KeywordEntry.html#afe7fdf97974af4ba7566d61172217cc9a2a97e529e1ba0ab4b622955238765cae">KeywordEntry::URL_KEYWORD_TYPE</a>,<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a19dbe71b1180a2b5c615b7b827517c32">UrlPathRelevance</a>(), weight, posKeyword-&gt;second.GetKeyword(), dictID, occurrence)
<a name="l00765"></a>00765                 );
<a name="l00766"></a>00766         }
<a name="l00767"></a>00767         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00768"></a>00768 }
<a name="l00769"></a>00769 
<a name="l00770"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a36ca38d834de7906a85bf96be70c1c73">00770</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a36ca38d834de7906a85bf96be70c1c73">XMLQueryResponse::GroupResults</a>(std::map&lt;long long, UrlStageEntry &gt;&amp; idUrlStages, <span class="keyword">const</span> std::vector&lt;long long&gt;&amp; sortedUrlStageIDs, <a class="code" href="../../d3/dcf/classqueryserver_1_1XMLQueryResponse_1_1OrderedResults.html">OrderedResults</a>&amp; orderedResults)
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772         std::vector&lt;long long&gt;::const_iterator iterSorted = sortedUrlStageIDs.begin();
<a name="l00773"></a>00773         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>&amp; groupFlag = <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#ac3c3ed6fa769468911a077043b536149">GroupingFlag</a>();
<a name="l00774"></a>00774 
<a name="l00775"></a>00775         <span class="keywordflow">if</span>(groupFlag &amp; <a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#ac002a9a00084430b942d487a0b3a8e4aa5f1f2376d890295c6997c48a448cf216">XMLQueryRequest::GROUPING_DOMAIN</a>) {
<a name="l00776"></a>00776 
<a name="l00777"></a>00777                 <span class="keywordflow">for</span>(;iterSorted != sortedUrlStageIDs.end();++iterSorted) {
<a name="l00778"></a>00778 
<a name="l00779"></a>00779                         <span class="keywordflow">if</span>(idUrlStages.count(*iterSorted) == 0) {
<a name="l00780"></a>00780                                 <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba629f976f682f75c5279ad61bcf7f306e" title="errors">log::Logging::LOGLEVEL_ERROR</a>,<span class="stringliteral">&quot;could not find urlstage id for grouping results&quot;</span>);
<a name="l00781"></a>00781                                 <span class="keywordflow">continue</span>;}
<a name="l00782"></a>00782 
<a name="l00783"></a>00783                         <a class="code" href="../../d2/d92/classqueryserver_1_1UrlStageEntry.html">UrlStageEntry</a>&amp; urlStageEntry  = idUrlStages.find(*iterSorted)-&gt;second;
<a name="l00784"></a>00784                         <span class="keywordtype">long</span> <span class="keywordtype">long</span> secondLevelDomainID = urlStageEntry.<a class="code" href="../../d2/d92/classqueryserver_1_1UrlStageEntry.html#a50086f5989f9138d77e9d3da4ca268de">UrlStageProperty</a>().<a class="code" href="../../df/de7/classqueryserver_1_1UrlStageProperties.html#addd722a992dc16871ed23b85cae1640a">SecondLevelDomainID</a>();
<a name="l00785"></a>00785                         <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlStageID          = urlStageEntry.<a class="code" href="../../d2/d92/classqueryserver_1_1UrlStageEntry.html#a50086f5989f9138d77e9d3da4ca268de">UrlStageProperty</a>().<a class="code" href="../../df/de7/classqueryserver_1_1UrlStageProperties.html#abcc6a0ae9b5ee174318d224d2a47baf7">UrlStageID</a>();
<a name="l00786"></a>00786 
<a name="l00787"></a>00787                         orderedResults.<a class="code" href="../../d3/dcf/classqueryserver_1_1XMLQueryResponse_1_1OrderedResults.html#a14971b5c9a4dbf55449f4e7cbfa09fe0">groupedSecondLevelDomainIDUrlStageID</a>[secondLevelDomainID].push_back(urlStageID);
<a name="l00788"></a>00788 
<a name="l00789"></a>00789                         <span class="comment">//add secondleveldomain only if it is not already there</span>
<a name="l00790"></a>00790                         std::vector&lt;long long&gt;::const_iterator iterFound =
<a name="l00791"></a>00791                                 std::find(
<a name="l00792"></a>00792                                                 orderedResults.<a class="code" href="../../d3/dcf/classqueryserver_1_1XMLQueryResponse_1_1OrderedResults.html#ae9452af2acc928107a00750915b7b117">sortedSecondLevelDomainID</a>.begin(),
<a name="l00793"></a>00793                                                 orderedResults.<a class="code" href="../../d3/dcf/classqueryserver_1_1XMLQueryResponse_1_1OrderedResults.html#ae9452af2acc928107a00750915b7b117">sortedSecondLevelDomainID</a>.end(),
<a name="l00794"></a>00794                                                 secondLevelDomainID     );
<a name="l00795"></a>00795                         <span class="keywordflow">if</span>( iterFound == orderedResults.<a class="code" href="../../d3/dcf/classqueryserver_1_1XMLQueryResponse_1_1OrderedResults.html#ae9452af2acc928107a00750915b7b117">sortedSecondLevelDomainID</a>.end()){
<a name="l00796"></a>00796                                 orderedResults.<a class="code" href="../../d3/dcf/classqueryserver_1_1XMLQueryResponse_1_1OrderedResults.html#aea550b4d50b77223a028f5e4daf4d22f">sortedUrlStageIDs</a>.push_back( urlStageEntry.<a class="code" href="../../d2/d92/classqueryserver_1_1UrlStageEntry.html#a50086f5989f9138d77e9d3da4ca268de">UrlStageProperty</a>().<a class="code" href="../../df/de7/classqueryserver_1_1UrlStageProperties.html#abcc6a0ae9b5ee174318d224d2a47baf7">UrlStageID</a>() );
<a name="l00797"></a>00797                                 orderedResults.<a class="code" href="../../d3/dcf/classqueryserver_1_1XMLQueryResponse_1_1OrderedResults.html#ae9452af2acc928107a00750915b7b117">sortedSecondLevelDomainID</a>.push_back(secondLevelDomainID); }
<a name="l00798"></a>00798                 }
<a name="l00799"></a>00799         } <span class="keywordflow">else</span> {
<a name="l00800"></a>00800                 <span class="comment">//no grouping</span>
<a name="l00801"></a>00801                 orderedResults.<a class="code" href="../../d3/dcf/classqueryserver_1_1XMLQueryResponse_1_1OrderedResults.html#aea550b4d50b77223a028f5e4daf4d22f">sortedUrlStageIDs</a> = sortedUrlStageIDs;
<a name="l00802"></a>00802         }
<a name="l00803"></a>00803         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00804"></a>00804 }
<a name="l00805"></a>00805 
<a name="l00806"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a135a325a76308f4205c77a474d02ffbb">00806</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a135a325a76308f4205c77a474d02ffbb">XMLQueryResponse::LogQuery</a>(<span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; vecKeywords, <span class="keywordtype">bool</span>&amp; isExistent)
<a name="l00807"></a>00807 {
<a name="l00808"></a>00808         <span class="comment">//is a new query,insert for logging</span>
<a name="l00809"></a>00809         <span class="keywordflow">if</span>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a0085f0e0633866ec7e7cc81c00fa1f7c">QueryID</a>() == -1) {
<a name="l00810"></a>00810 
<a name="l00811"></a>00811                 <a class="code" href="../../d0/d50/classnetwork_1_1HttpCookie.html">network::HttpCookie</a> sessionCookie;
<a name="l00812"></a>00812                 <span class="keywordflow">if</span>(!<a class="code" href="../../dd/dca/classnetwork_1_1HttpCookieHelper.html#affbc2f2a60b981bc736036a51a68bd09">network::HttpCookieHelper::GetCookieByKey</a>(<span class="stringliteral">&quot;SIRIDIAID&quot;</span>,<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../db/d8d/classfastcgiserver_1_1FastCGIRequest.html#a07cfb556677669cf1dc6f19682cdc37a" title="gets cookies from current request.">Cookies</a>(),sessionCookie)){
<a name="l00813"></a>00813                         <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba629f976f682f75c5279ad61bcf7f306e" title="errors">log::Logging::LOGLEVEL_ERROR</a>,<span class="stringliteral">&quot;no session id found&quot;</span>);
<a name="l00814"></a>00814                         <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816                 <a class="code" href="../../dd/d42/classdatabase_1_1searchqueryTableBase.html" title="wrapper class for database table searchquery">database::searchqueryTableBase</a> tblQuery;
<a name="l00817"></a>00817                 tblQuery.<a class="code" href="../../dd/d42/classdatabase_1_1searchqueryTableBase.html#acf231a3318a5fab32444cd15f29d8ae9" title="sets value of session.">Set_session</a>(sessionCookie.<a class="code" href="../../d0/d50/classnetwork_1_1HttpCookie.html#a66c5639e15560c98fcd543b3199ac29c">GetValue</a>());
<a name="l00818"></a>00818                 tblQuery.<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a7074fc21ba63550c57c04565b8589feb" title="inserts this table.">Insert</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>());
<a name="l00819"></a>00819 
<a name="l00820"></a>00820                 <span class="keywordflow">if</span>( !<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ae3e739c6073683d155a6a83736029724" title="gets last inserted id.">LastInsertID</a>( <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#aab0a499f1dae7e0166ecc3695d8f38fe">queryID</a> ) ) {
<a name="l00821"></a>00821                         <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823                 std::vector&lt;std::string&gt;::const_iterator iterKeywords = vecKeywords.begin();
<a name="l00824"></a>00824                 <span class="keywordflow">for</span>(;iterKeywords != vecKeywords.end();++iterKeywords) {
<a name="l00825"></a>00825 
<a name="l00826"></a>00826                         <span class="keyword">const</span> std::string&amp; keyword = *iterKeywords;
<a name="l00827"></a>00827 
<a name="l00828"></a>00828                         <a class="code" href="../../d3/d3b/classdatabase_1_1keywordqueryTableBase.html" title="wrapper class for database table keywordquery">database::keywordqueryTableBase</a> tblKeywordQuery;
<a name="l00829"></a>00829                         tblKeywordQuery.<a class="code" href="../../d3/d3b/classdatabase_1_1keywordqueryTableBase.html#a5ef75e4730a78ee3ac9fd01fd1640798" title="sets value of query_part.">Set_query_part</a>(keyword);
<a name="l00830"></a>00830                         tblKeywordQuery.<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a8d2c18bc90ada049a00e012b14423445" title="inserts or updates this table.">InsertOrUpdate</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>());
<a name="l00831"></a>00831 
<a name="l00832"></a>00832                         <span class="keywordtype">long</span> <span class="keywordtype">long</span> keywordQueryID = -1;
<a name="l00833"></a>00833                         <span class="keywordflow">if</span>( !<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>()-&gt;<a class="code" href="../../d2/d7c/classdatabase_1_1DatabaseConnection.html#ae3e739c6073683d155a6a83736029724" title="gets last inserted id.">LastInsertID</a>(keywordQueryID) || keywordQueryID == -1) {
<a name="l00834"></a>00834                                 <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba629f976f682f75c5279ad61bcf7f306e" title="errors">log::Logging::LOGLEVEL_ERROR</a>,<span class="stringliteral">&quot;error while inserting keyword id: &quot;</span> + keyword);
<a name="l00835"></a>00835                                 <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837                         <a class="code" href="../../df/dbc/classdatabase_1_1searchquerykeywordsTableBase.html" title="wrapper class for database table searchquerykeywords">database::searchquerykeywordsTableBase</a> searchQueryKeyword;
<a name="l00838"></a>00838                         searchQueryKeyword.<a class="code" href="../../df/dbc/classdatabase_1_1searchquerykeywordsTableBase.html#a099d3cf39d5cbb9f4c0b5b2e9d3155d1" title="sets value of KEYWORDQUERY_ID.">Set_KEYWORDQUERY_ID</a>(keywordQueryID);
<a name="l00839"></a>00839                         searchQueryKeyword.<a class="code" href="../../df/dbc/classdatabase_1_1searchquerykeywordsTableBase.html#a940212461bd958ab652c769f74d5bd7c" title="sets value of SEARCHQUERY_ID.">Set_SEARCHQUERY_ID</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a0085f0e0633866ec7e7cc81c00fa1f7c">QueryID</a>());
<a name="l00840"></a>00840                         searchQueryKeyword.<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a8d2c18bc90ada049a00e012b14423445" title="inserts or updates this table.">InsertOrUpdate</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>());
<a name="l00841"></a>00841                 }
<a name="l00842"></a>00842         }
<a name="l00843"></a>00843         <span class="keywordflow">else</span> {
<a name="l00844"></a>00844                 <span class="comment">//TODO: check if combination of search query id and session id exists and is valid, i.e. so that nobody can list each others results</span>
<a name="l00845"></a>00845                 isExistent = <span class="keyword">true</span>;
<a name="l00846"></a>00846         }
<a name="l00847"></a>00847         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00848"></a>00848 }
<a name="l00849"></a>00849 
<a name="l00850"></a><a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a480990b21b308115ca2cc3a5c3fa5479">00850</a> <span class="keywordtype">bool</span> <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a480990b21b308115ca2cc3a5c3fa5479">XMLQueryResponse::SaveResults</a>(
<a name="l00851"></a>00851                 <span class="keyword">const</span> std::vector&lt;long long&gt;&amp; sortedUrlStageIDs,
<a name="l00852"></a>00852                 <span class="keyword">const</span> std::map&lt;long long, long long&gt;&amp; mapUrlStageIDUrlID)
<a name="l00853"></a>00853 {
<a name="l00854"></a>00854         <span class="keywordtype">bool</span> success = <span class="keyword">true</span>;
<a name="l00855"></a>00855         <a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#adc683ece48a6f24b23b8df70b7f7c3c9">countResults</a> = sortedUrlStageIDs.size();
<a name="l00856"></a>00856         std::vector&lt;long long&gt;::const_iterator iterSortedUrlStage = sortedUrlStageIDs.begin();
<a name="l00857"></a>00857         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;iterSortedUrlStage != sortedUrlStageIDs.end();i++,++iterSortedUrlStage) {
<a name="l00858"></a>00858                 <span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlStageID = *iterSortedUrlStage;
<a name="l00859"></a>00859                 <span class="keyword">const</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> urlID      = mapUrlStageIDUrlID.at(urlStageID);
<a name="l00860"></a>00860 
<a name="l00861"></a>00861                 <a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html" title="wrapper class for database table queryresults">database::queryresultsTableBase</a> tblResult;
<a name="l00862"></a>00862                 tblResult.<a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a72ccef4c2838d80a94fc229dbda17bef" title="sets value of SEARCHQUERY_ID.">Set_SEARCHQUERY_ID</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a7e6e170dcae6bd87a16b68c7b418c258">xmlQueryRequest</a>-&gt;<a class="code" href="../../da/db0/classqueryserver_1_1XMLQueryRequest.html#a3704d91a4c708a043bc9ec797383fa11">Params</a>().<a class="code" href="../../dc/dfc/classqueryserver_1_1XMLQueryRequest_1_1QueryRequestParam.html#a0085f0e0633866ec7e7cc81c00fa1f7c">QueryID</a>());
<a name="l00863"></a>00863                 tblResult.<a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a321c30db89573caa2b60ec7f5133edd1" title="sets value of URLSTAGE_ID.">Set_URLSTAGE_ID</a>(urlStageID);
<a name="l00864"></a>00864                 tblResult.<a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a2375fb159a0cb91b850033b1a5816d14" title="sets value of URL_ID.">Set_URL_ID</a>(urlID);
<a name="l00865"></a>00865                 tblResult.<a class="code" href="../../db/d00/classdatabase_1_1queryresultsTableBase.html#a47e378c5efa37c49154869e9d3cefd1e" title="sets value of order_position.">Set_order_position</a>(i);
<a name="l00866"></a>00866                 tblResult.<a class="code" href="../../dc/d42/classdatabase_1_1TableBase.html#a7074fc21ba63550c57c04565b8589feb" title="inserts this table.">Insert</a>(<a class="code" href="../../d7/d46/classqueryserver_1_1XMLQueryResponse.html#a3f99cfbfe4a523bfea16850a6df6b4b1">dbHelper</a>.<a class="code" href="../../dc/d55/classdatabase_1_1DatabaseHelper.html#af4b03ab880b8d2922a8e36b2c5ebb56c" title="gets current database connection.">Connection</a>());
<a name="l00867"></a>00867         }
<a name="l00868"></a>00868 
<a name="l00869"></a>00869         <span class="keywordflow">if</span>( !success ) {
<a name="l00870"></a>00870                 <a class="code" href="../../d4/d4f/classlog_1_1Logging.html#ad7e7f55eab00ca54b992cd2efe115cab" title="log a message.">log::Logging::Log</a>(<a class="code" href="../../d4/d4f/classlog_1_1Logging.html#af95f7204c20431b96da9efb6c83bae8ba629f976f682f75c5279ad61bcf7f306e" title="errors">log::Logging::LOGLEVEL_ERROR</a>,<span class="stringliteral">&quot;error while inserting results&quot;</span>); }
<a name="l00871"></a>00871         <span class="keywordflow">return</span> success;
<a name="l00872"></a>00872 }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Jul 3 2013 23:43:23 for DeepNet by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
